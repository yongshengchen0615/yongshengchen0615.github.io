<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¸«å‚…ç‹€æ…‹çœ‹æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-sub: #6b7280;
      --accent: #3b82f6;
      --accent-soft: #dbeafe;
      --danger: #ef4444;
      --danger-soft: #fee2e2;
      --success: #16a34a;
      --success-soft: #dcfce7;
      --muted: #9ca3af;
      --muted-soft: #f3f4f6;
      --radius-lg: 12px;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .layout {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .title {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .title-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }

    button {
      cursor: pointer;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s, box-shadow 0.15s, transform 0.05s;
    }

    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    button:hover {
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.15);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .pill {
      font-size: 12px;
      border-radius: 999px;
      padding: 4px 10px;
      background: var(--muted-soft);
      color: var(--text-sub);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--success);
      margin-right: 4px;
    }

    .main-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 16px;
    }

    @media (max-width: 800px) {
      .main-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .card-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #fee2e2;
      color: #b91c1c;
      font-weight: 600;
    }

    .card-meta {
      font-size: 11px;
      color: var(--text-sub);
      text-align: right;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 420px;
    }

    thead {
      background: #f9fafb;
    }

    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
    }

    th {
      text-align: left;
      font-weight: 600;
      color: var(--text-sub);
      font-size: 12px;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    tbody tr:hover {
      background: #eff6ff;
    }

    .text-right {
      text-align: right;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-working {
      background: var(--accent-soft);
      color: var(--accent);
    }

    .status-on {
      background: var(--success-soft);
      color: var(--success);
    }

    .status-off {
      background: var(--muted-soft);
      color: var(--muted);
    }

    .status-unknown {
      background: var(--muted-soft);
      color: var(--text-sub);
    }

    .remaining-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 500;
    }

    .remaining-good {
      background: var(--success-soft);
      color: var(--success);
    }

    .remaining-bad {
      background: var(--danger-soft);
      color: var(--danger);
    }

    .remaining-neutral {
      background: var(--muted-soft);
      color: var(--text-sub);
    }

    .badge-master {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-variant-numeric: tabular-nums;
    }

    .badge-master span.code {
      font-weight: 600;
      padding: 1px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4338ca;
      font-size: 11px;
    }

    .empty-state {
      padding: 12px;
      font-size: 12px;
      color: var(--text-sub);
      text-align: center;
    }

    .footer {
      font-size: 11px;
      color: var(--text-sub);
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
    }

    .footer span {
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="layout">
    <header>
      <div class="title">
        å¸«å‚…ç‹€æ…‹çœ‹æ¿
        <span class="title-badge">Google Sheet å³æ™‚åŒæ­¥</span>
      </div>
      <div class="controls">
        <button id="refreshBtn" class="primary">
          ğŸ”„ é‡æ–°æ•´ç†
        </button>
        <label class="pill">
          <input type="checkbox" id="autoRefreshToggle" style="margin-right: 4px" />
          è‡ªå‹•æ›´æ–°ï¼ˆæ¯ 10 ç§’ï¼‰
        </label>
        <div class="pill" id="lastUpdatedPill">
          <span class="pill-dot"></span>
          <span id="lastUpdatedText">å°šæœªè¼‰å…¥</span>
        </div>
      </div>
    </header>

    <div class="main-grid">
      <!-- èº«é«” -->
      <section class="card" id="bodyCard">
        <div class="card-header">
          <div class="card-title">
            èº«é«”
            <span class="card-title-tag">Data_Body</span>
          </div>
          <div class="card-meta">
            <span id="bodyCount">0 ä½å¸«å‚…</span>
          </div>
        </div>
        <div class="table-wrapper" id="bodyTableWrapper">
          <div class="empty-state">å°šç„¡è³‡æ–™</div>
        </div>
      </section>

      <!-- è…³åº• -->
      <section class="card" id="footCard">
        <div class="card-header">
          <div class="card-title">
            è…³åº•
            <span class="card-title-tag">Data_Foot</span>
          </div>
          <div class="card-meta">
            <span id="footCount">0 ä½å¸«å‚…</span>
          </div>
        </div>
        <div class="table-wrapper" id="footTableWrapper">
          <div class="empty-state">å°šç„¡è³‡æ–™</div>
        </div>
      </section>
    </div>

    <div class="footer">
      <span>ç‹€æ…‹ï¼šå·¥ä½œä¸­ / ä¸Šç­ / ä¸‹ç­ï¼ˆä¾ Sheet æ¬„ä½ <code>status</code> é¡¯ç¤ºï¼‰</span>
      <span>è³‡æ–™ä¾†æºï¼šGoogle Apps Script Web App â†’ Data_Body / Data_Foot</span>
    </div>
  </div>

  <script>
    // TODO: é€™è£¡æ›æˆä½ çš„ Web App URLï¼ˆ/execï¼‰
    const API_URL = "https://script.google.com/macros/s/AKfycbwXwpKPzQFuIWtZOJpeGU9aPbl3RR5bj9yVWjV7mfyYaABaxMetKn_3j_mdMJGN9Ok5Ug/exec";

    const bodyTableWrapper = document.getElementById("bodyTableWrapper");
    const footTableWrapper = document.getElementById("footTableWrapper");
    const bodyCountEl = document.getElementById("bodyCount");
    const footCountEl = document.getElementById("footCount");
    const lastUpdatedText = document.getElementById("lastUpdatedText");
    const refreshBtn = document.getElementById("refreshBtn");
    const autoRefreshToggle = document.getElementById("autoRefreshToggle");

    let autoRefreshTimer = null;

    function formatTime(ts) {
      const d = ts ? new Date(ts) : new Date();
      const pad = (n) => (n < 10 ? "0" + n : "" + n);
      return (
        d.getFullYear() +
        "-" +
        pad(d.getMonth() + 1) +
        "-" +
        pad(d.getDate()) +
        " " +
        pad(d.getHours()) +
        ":" +
        pad(d.getMinutes()) +
        ":" +
        pad(d.getSeconds())
      );
    }

    function getStatusClass(status) {
      if (!status) return "status-unknown";
      if (status.includes("å·¥ä½œ")) return "status-working";
      if (status.includes("ä¸Šç­")) return "status-on";
      if (status.includes("ä¸‹ç­")) return "status-off";
      return "status-unknown";
    }

    function getRemainingClass(remaining) {
      if (remaining === "" || remaining === null || remaining === undefined) {
        return "remaining-neutral";
      }
      const num = Number(remaining);
      if (isNaN(num)) return "remaining-neutral";
      if (num < 0) return "remaining-bad";
      if (num > 0) return "remaining-good";
      return "remaining-neutral";
    }

    function safe(val, placeholder = "-") {
      if (val === null || val === undefined || val === "") return placeholder;
      return val;
    }

    function renderTable(wrapperEl, rows) {
      if (!rows || rows.length === 0) {
        wrapperEl.innerHTML =
          '<div class="empty-state">å°šç„¡è³‡æ–™ï¼Œè«‹ç¨å€™æˆ–æª¢æŸ¥ Google Sheetã€‚</div>';
        return;
      }

      const header = `
        <table>
          <thead>
            <tr>
              <th>æ’åº</th>
              <th>å¸«å‚…</th>
              <th>ç‹€æ…‹</th>
              <th>é ç´„æ™‚é–“</th>
              <th class="text-right">å‰©é¤˜</th>
            </tr>
          </thead>
          <tbody>
      `;

      const bodyHtml = rows
        .map((row) => {
          const statusClass = getStatusClass(String(row.status || ""));
          const remainingClass = getRemainingClass(row.remaining);
          const sortVal = safe(row.sort || row.index, "-");
          const masterId = safe(row.masterId, "-");
          const appointment = safe(row.appointment, "-");
          const remaining = row.remaining === 0 || row.remaining
            ? row.remaining
            : "-";

          return `
            <tr>
              <td>${sortVal}</td>
              <td>
                <span class="badge-master">
                  <span>å¸«å‚…</span>
                  <span class="code">${masterId}</span>
                </span>
              </td>
              <td>
                <span class="status-badge ${statusClass}">
                  ${safe(row.status, "æœªçŸ¥")}
                </span>
              </td>
              <td>${appointment}</td>
              <td class="text-right">
                <span class="remaining-badge ${remainingClass}">
                  ${remaining}
                </span>
              </td>
            </tr>
          `;
        })
        .join("");

      const footer = `
          </tbody>
        </table>
      `;

      wrapperEl.innerHTML = header + bodyHtml + footer;
    }

    async function loadData() {
      refreshBtn.disabled = true;
      refreshBtn.textContent = "è¼‰å…¥ä¸­â€¦";

      try {
        const res = await fetch(API_URL, {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        });

        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }

        const data = await res.json();

        if (!data.ok) {
          throw new Error(data.error || "GAS å›å‚³éŒ¯èª¤");
        }

        const bodyRows = Array.isArray(data.body) ? data.body : [];
        const footRows = Array.isArray(data.foot) ? data.foot : [];

        // å¯ä»¥ä¾ sort æ’åº
        bodyRows.sort((a, b) => (Number(a.sort) || 0) - (Number(b.sort) || 0));
        footRows.sort((a, b) => (Number(a.sort) || 0) - (Number(b.sort) || 0));

        renderTable(bodyTableWrapper, bodyRows);
        renderTable(footTableWrapper, footRows);

        bodyCountEl.textContent = bodyRows.length + " ä½å¸«å‚…";
        footCountEl.textContent = footRows.length + " ä½å¸«å‚…";

        lastUpdatedText.textContent = "æœ€å¾Œæ›´æ–°ï¼š" + formatTime(Date.now());
      } catch (err) {
        console.error("[Dashboard] è®€å–å¤±æ•—ï¼š", err);
        bodyTableWrapper.innerHTML =
          '<div class="empty-state">è¼‰å…¥å¤±æ•—ï¼š' +
          err +
          "<br>è«‹ç¢ºèª API_URL æ˜¯å¦æ­£ç¢ºã€GAS å·²éƒ¨ç½²ä¸¦å…è¨±åŒ¿åå­˜å–ã€‚</div>";
        footTableWrapper.innerHTML = bodyTableWrapper.innerHTML;
        lastUpdatedText.textContent = "è¼‰å…¥å¤±æ•—ï¼š" + err;
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.textContent = "ğŸ”„ é‡æ–°æ•´ç†";
      }
    }

    function setupAutoRefresh(enabled) {
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
      }
      if (enabled) {
        autoRefreshTimer = setInterval(loadData, 10000); // 10 ç§’
      }
    }

    refreshBtn.addEventListener("click", () => {
      loadData();
    });

    autoRefreshToggle.addEventListener("change", (e) => {
      setupAutoRefresh(e.target.checked);
    });

    // é¦–æ¬¡è¼‰å…¥
    loadData();
  </script>
</body>
</html>
