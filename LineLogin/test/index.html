<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE Login & Firebase 留言板</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, push, set, update, remove, onValue } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
        
        // Firebase 設定
        const firebaseConfig = {
            apiKey: "AIzaSyCQpelp4H9f-S0THHgSiIJHCzyvNG3AGvs",
            authDomain: "reservesystem-c8bbc.firebaseapp.com",
            databaseURL: "https://reservesystem-c8bbc-default-rtdb.firebaseio.com",
            projectId: "reservesystem-c8bbc",
            storageBucket: "reservesystem-c8bbc.firebasestorage.app",
            messagingSenderId: "138232489371",
            appId: "1:138232489371:web:b5358137baf293f9ae2d3e",
            measurementId: "G-RZ9XSVK925"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let userId = "";

        async function login() {
            await liff.init({ liffId: "2005939681-ayjyxlz3" });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                userId = profile.userId;
                document.getElementById("userInfo").innerText = `Hello, ${profile.displayName}`;
                loadMessages();
            }
        }
        
        function logout() {
            liff.logout();
            location.reload();
        }
        
        function addMessage() {
            const messageInput = document.getElementById("messageInput").value;
            if (messageInput.trim() === "") return;
            const newMessageRef = push(ref(db, "messages"));
            set(newMessageRef, {
                userId: userId,
                message: messageInput,
                timestamp: Date.now()
            });
            document.getElementById("messageInput").value = "";
        }
        
        function updateMessage(id, newMessage) {
            update(ref(db, `messages/${id}`), { message: newMessage });
        }
        
        function deleteMessage(id) {
            remove(ref(db, `messages/${id}`));
        }
        
        function loadMessages() {
            onValue(ref(db, "messages"), (snapshot) => {
                const messagesDiv = document.getElementById("messages");
                messagesDiv.innerHTML = "";
                snapshot.forEach((childSnapshot) => {
                    const messageData = childSnapshot.val();
                    const messageId = childSnapshot.key;
                    
                    const messageElement = document.createElement("div");
                    messageElement.innerHTML = `
                        <p>${messageData.message} <button onclick="editMessage('${messageId}', '${messageData.message}')">修改</button> <button onclick="deleteMessage('${messageId}')">刪除</button></p>
                    `;
                    messagesDiv.appendChild(messageElement);
                });
            });
        }
        
        window.addMessage = addMessage;
        window.deleteMessage = deleteMessage;
        window.editMessage = (id, oldMessage) => {
            const newMessage = prompt("修改留言:", oldMessage);
            if (newMessage) updateMessage(id, newMessage);
        };
        
        window.onload = login;
    </script>
</head>
<body>
    <h1>LINE Login & Firebase 留言板</h1>
    <p id="userInfo">請登入...</p>
    <button onclick="logout()">登出</button>
    <br><br>
    <input type="text" id="messageInput" placeholder="輸入留言...">
    <button onclick="addMessage()">送出</button>
    <div id="messages"></div>
</body>
</html>
