<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE 預約系統</title>
    <script type="module">
        // 引入 Firebase 最新 SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        // Firebase 設定
        const firebaseConfig = {
            apiKey: "AIzaSyCQpelp4H9f-S0THHgSiIJHCzyvNG3AGvs",
  authDomain: "reservesystem-c8bbc.firebaseapp.com",
  databaseURL: "https://reservesystem-c8bbc-default-rtdb.firebaseio.com",
  projectId: "reservesystem-c8bbc",
  storageBucket: "reservesystem-c8bbc.firebasestorage.app",
  messagingSenderId: "138232489371",
  appId: "1:138232489371:web:b5358137baf293f9ae2d3e",
  measurementId: "G-RZ9XSVK925"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // LINE 登入設定
        const clientId = "2005939681";
        const redirectUri = window.location.origin; // 目前網頁 URL

        document.addEventListener("DOMContentLoaded", () => {
            const loginBtn = document.getElementById("loginBtn");
            const logoutBtn = document.getElementById("logoutBtn");
            const userInfo = document.getElementById("userInfo");
            const userAvatar = document.getElementById("userAvatar");
            const userName = document.getElementById("userName");
            const reservationForm = document.querySelector(".form");

            loginBtn.addEventListener("click", () => {
                window.location.href = `https://access.line.me/oauth2/v2.1/authorize?response_type=token&client_id=${clientId}&redirect_uri=${redirectUri}&scope=profile%20openid&state=12345`;
            });

            logoutBtn.addEventListener("click", () => {
                localStorage.clear();
                window.location.href = redirectUri;
            });

            // 解析 URL 取得 access_token
            function getAccessToken() {
                const hash = window.location.hash.substring(1);
                const params = new URLSearchParams(hash);
                return params.get("access_token");
            }

            async function fetchUserProfile() {
                const token = getAccessToken();
                if (!token) return;

                const response = await fetch("https://api.line.me/v2/profile", {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await response.json();
                localStorage.setItem("userName", data.displayName);
                localStorage.setItem("userAvatar", data.pictureUrl);

                userAvatar.src = data.pictureUrl;
                userName.textContent = data.displayName;
                userInfo.style.display = "block";
                reservationForm.style.display = "block";
                loginBtn.style.display = "none";
                logoutBtn.style.display = "block";
            }

            if (localStorage.getItem("userName")) {
                userAvatar.src = localStorage.getItem("userAvatar");
                userName.textContent = localStorage.getItem("userName");
                userInfo.style.display = "block";
                reservationForm.style.display = "block";
                loginBtn.style.display = "none";
                logoutBtn.style.display = "block";
            } else {
                fetchUserProfile();
            }

            // 預約功能
            document.getElementById("reserveBtn").addEventListener("click", () => {
                const date = document.getElementById("date").value;
                const time = document.getElementById("time").value;
                if (!date || !time) {
                    alert("請選擇時間");
                    return;
                }
                const user = localStorage.getItem("userName");
                push(ref(db, "appointments"), { user, date, time });
                alert("預約成功！");
            });
        });
    </script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        .container { max-width: 500px; margin: auto; padding: 20px; }
        .avatar { width: 100px; height: 100px; border-radius: 50%; border: 2px solid #4CAF50; }
        .btn { padding: 10px 15px; margin: 10px; cursor: pointer; border: none; color: white; }
        .login-btn { background: #06C755; }
        .logout-btn { background: red; display: none; }
        .form { display: none; }
        input, select, button { width: 100%; margin: 5px 0; padding: 10px; }
    </style>
</head>
<body>

    <h2>LINE 預約系統</h2>
    <button id="loginBtn" class="btn login-btn">使用 LINE 登入</button>
    <button id="logoutBtn" class="btn logout-btn">登出</button>
    
    <div id="userInfo" class="container" style="display:none;">
        <img id="userAvatar" class="avatar" src="" alt="頭像">
        <h3 id="userName"></h3>
    </div>

    <div class="form">
        <h3>預約時間</h3>
        <input type="date" id="date">
        <input type="time" id="time">
        <button id="reserveBtn" class="btn">預約</button>
    </div>

</body>
</html>
