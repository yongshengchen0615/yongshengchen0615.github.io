<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>預約系統</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script type="module">
        // ✅ 1. 載入 Firebase 最新 SDK (v10+)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";
        import { getAuth, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

        // ✅ 2. 初始化 Firebase 設定
        const firebaseConfig = {
            apiKey: "AIzaSyCQpelp4H9f-S0THHgSiIJHCzyvNG3AGvs",
  authDomain: "reservesystem-c8bbc.firebaseapp.com",
  databaseURL: "https://reservesystem-c8bbc-default-rtdb.firebaseio.com",
  projectId: "reservesystem-c8bbc",
  storageBucket: "reservesystem-c8bbc.firebasestorage.app",
  messagingSenderId: "138232489371",
  appId: "1:138232489371:web:b5358137baf293f9ae2d3e",
  measurementId: "G-RZ9XSVK925"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // ✅ 3. 初始化 LINE LIFF
        async function initLiff() {
            await liff.init({ liffId: "2005939681-ayjyxlz3" });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                document.getElementById("userInfo").innerText = `歡迎, ${profile.displayName}`;
                document.getElementById("loginBtn").style.display = "none";
                document.getElementById("logoutBtn").style.display = "inline";
                handleLoginWithFirebase();
            }
        }

        // ✅ 4. 透過 Firebase SignIn 記錄使用者
        async function handleLoginWithFirebase() {
            const idToken = await liff.getIDToken();
            const response = await fetch("YOUR_SERVER_ENDPOINT_TO_GENERATE_CUSTOM_TOKEN", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ idToken }),
            });
            const data = await response.json();
            signInWithCustomToken(auth, data.firebaseToken).then(() => {
                loadAppointments(auth.currentUser.uid);
            });
        }

        document.getElementById("loginBtn").addEventListener("click", initLiff);
        document.getElementById("logoutBtn").addEventListener("click", () => {
            signOut(auth).then(() => {
                liff.logout();
                location.reload();
            });
        });

        // ✅ 5. 新增預約
        document.getElementById("appointmentForm").addEventListener("submit", function (e) {
            e.preventDefault();
            const title = document.getElementById("appointmentTitle").value;
            const time = document.getElementById("appointmentTime").value;
            const userId = auth.currentUser.uid;

            const newRef = push(ref(db, `appointments/${userId}`));
            set(newRef, { title, time }).then(() => {
                alert("預約成功！");
                document.getElementById("appointmentForm").reset();
                loadAppointments(userId);
            });
        });

        // ✅ 6. 載入預約資料
        function loadAppointments(userId) {
            onValue(ref(db, `appointments/${userId}`), (snapshot) => {
                const list = document.getElementById("appointmentList");
                list.innerHTML = "";
                snapshot.forEach((child) => {
                    const data = child.val();
                    const li = document.createElement("li");
                    li.innerHTML = `${data.title} - ${data.time} 
                        <button onclick="editAppointment('${userId}', '${child.key}', '${data.title}', '${data.time}')">編輯</button>
                        <button onclick="deleteAppointment('${userId}', '${child.key}')">刪除</button>`;
                    list.appendChild(li);
                });
            });
        }

        // ✅ 7. 刪除預約
        function deleteAppointment(userId, key) {
            remove(ref(db, `appointments/${userId}/${key}`)).then(() => {
                alert("刪除成功！");
                loadAppointments(userId);
            });
        }

        // ✅ 8. 編輯預約
        function editAppointment(userId, key, oldTitle, oldTime) {
            const newTitle = prompt("修改預約名稱", oldTitle);
            const newTime = prompt("修改預約時間 (YYYY-MM-DDTHH:MM)", oldTime);
            if (newTitle && newTime) {
                update(ref(db, `appointments/${userId}/${key}`), { title: newTitle, time: newTime }).then(() => {
                    alert("修改成功！");
                    loadAppointments(userId);
                });
            }
        }

        // ✅ 9. 監聽登入狀態變化
        liff.ready.then(() => {
            if (liff.isLoggedIn()) {
                handleLoginWithFirebase();
            }
        });

    </script>
</head>
<body>
    <h1>LINE 預約系統</h1>
    <button id="loginBtn">使用 LINE 登入</button>
    <button id="logoutBtn" style="display:none;">登出</button>
    <p id="userInfo"></p>

    <h2>預約管理</h2>
    <form id="appointmentForm">
        <input type="text" id="appointmentTitle" placeholder="輸入預約事項" required>
        <input type="datetime-local" id="appointmentTime" required>
        <button type="submit">新增預約</button>
    </form>

    <h2>您的預約列表</h2>
    <ul id="appointmentList"></ul>
</body>
</html>
