<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE 登入與預約系統</title>

    <!-- LINE SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <!-- Firebase 最新 SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, set, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // 替換成你的 Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyCQpelp4H9f-S0THHgSiIJHCzyvNG3AGvs",
            authDomain: "reservesystem-c8bbc.firebaseapp.com",
            databaseURL: "https://reservesystem-c8bbc-default-rtdb.firebaseio.com",
            projectId: "reservesystem-c8bbc",
            storageBucket: "reservesystem-c8bbc.firebasestorage.app",
            messagingSenderId: "138232489371",
            appId: "1:138232489371:web:b5358137baf293f9ae2d3e"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // 替換為你的 LIFF ID
        const liffId = "2005939681-ayjyxlz3";

        document.addEventListener("DOMContentLoaded", async function () {
            await liff.init({ liffId });

            if (liff.isLoggedIn()) {
                getUserProfile();
            } else {
                document.getElementById("loginSection").style.display = "block";
            }

            document.getElementById("loginBtn").addEventListener("click", () => liff.login());
            document.getElementById("logoutBtn").addEventListener("click", () => {
                liff.logout();
                location.reload();
            });

            document.getElementById("bookingForm").addEventListener("submit", function (e) {
                e.preventDefault();
                saveBooking();
            });
        });

        async function getUserProfile() {
            const profile = await liff.getProfile();
            document.getElementById("userName").textContent = profile.displayName;
            document.getElementById("userPicture").src = profile.pictureUrl;

            document.getElementById("loginSection").style.display = "none";
            document.getElementById("userInfo").style.display = "block";
            document.getElementById("bookingSection").style.display = "block";
        }

        function saveBooking() {
            const name = document.getElementById("name").value;
            const date = document.getElementById("date").value;
            const time = document.getElementById("time").value;

            if (!name || !date || !time) {
                alert("請填寫完整的預約資訊！");
                return;
            }

            const bookingRef = push(ref(database, "bookings"));
            set(bookingRef, {
                name,
                date,
                time,
                timestamp: serverTimestamp()
            }).then(() => {
                alert("預約成功！");
                document.getElementById("bookingForm").reset();
            }).catch((error) => {
                alert("預約失敗：" + error.message);
            });
        }
    </script>

    <!-- Bootstrap 樣式 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body class="container py-5">

    <h2 class="text-center">LINE 登入與預約系統</h2>

    <div id="loginSection" class="text-center">
        <button id="loginBtn" class="btn btn-success">使用 LINE 登入</button>
    </div>

    <div id="userInfo" class="mt-4" style="display: none;">
        <p><strong>使用者：</strong><span id="userName"></span></p>
        <img id="userPicture" class="rounded-circle" width="100" alt="User Profile">
        <button id="logoutBtn" class="btn btn-danger">登出</button>
    </div>

    <div id="bookingSection" class="mt-4" style="display: none;">
        <h3>預約表單</h3>
        <form id="bookingForm">
            <div class="mb-3">
                <label for="name" class="form-label">姓名</label>
                <input type="text" id="name" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="date" class="form-label">預約日期</label>
                <input type="date" id="date" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="time" class="form-label">預約時間</label>
                <input type="time" id="time" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">提交預約</button>
        </form>
    </div>

</body>
</html>
