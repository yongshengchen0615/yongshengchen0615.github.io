<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Admin 審核管理台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="admin.css" />

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <!-- 初始資料載入遮罩：首批資料準備好前顯示 -->
  <div id="initialLoading" class="initial-loading initial-loading-hidden">
    <div class="initial-loading-inner" role="status" aria-live="polite">
      <div class="spinner-lg" aria-hidden="true"></div>
      <p id="initialLoadingText" class="initial-loading-text">資料載入中…</p>
      <div class="initial-loading-progress" role="progressbar" aria-label="載入進度" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div id="initialLoadingBar" class="initial-loading-progress-bar" style="width:0%"></div>
      </div>
      <div id="initialLoadingPercent" class="initial-loading-percent">0%</div>
    </div>
  </div>

  <div class="app app-hidden">
    <div class="shell">

      <header class="topbar">
        <div class="brand">
          <div class="brand-mark">A</div>
          <div class="brand-text">
            <h1>Admin 審核管理台</h1>
            <p id="summaryText">載入中…</p>
            <p id="authText" class="auth-text">尚未登入</p>
          </div>
        </div>

        <div class="topbar-right">
          <button id="themeToggle" class="btn ghost" type="button">切換主題</button>
        </div>
      </header>

      <div class="viewbar" aria-label="切換名單">
        <button id="viewAdminsBtn" class="btn primary" type="button" aria-pressed="true">管理員名單</button>
        <button id="viewAdminLogsBtn" class="btn ghost" type="button" aria-pressed="false">管理員紀錄</button>
        <button id="viewUsersBtn" class="btn ghost" type="button" aria-pressed="false">技師名單</button>
        <button id="viewTechUsageLogsBtn" class="btn ghost" type="button" aria-pressed="false">技師使用紀錄</button>
      </div>

      <section id="adminsKpiSection" class="kpi-grid" aria-label="統計資訊">
        <div class="kpi-card">
          <div class="kpi-label">總管理員</div>
          <div class="kpi-value" id="kpiTotal">-</div>
        </div>
        <div class="kpi-card success">
          <div class="kpi-label">通過</div>
          <div class="kpi-value" id="kpiApproved">-</div>
        </div>
        <div class="kpi-card warning">
          <div class="kpi-label">待審核</div>
          <div class="kpi-value" id="kpiPending">-</div>
        </div>
        <div class="kpi-card danger">
          <div class="kpi-label">拒絕</div>
          <div class="kpi-value" id="kpiRejected">-</div>
        </div>

        <div class="kpi-card muted">
          <div class="kpi-label">停用</div>
          <div class="kpi-value" id="kpiDisabled">-</div>
        </div>
        <div class="kpi-card maintenance">
          <div class="kpi-label">系統維護</div>
          <div class="kpi-value" id="kpiMaintenance">-</div>
        </div>
      </section>

      <section id="adminsPanelSection" class="panel">
        <div class="panel-head">
          <div class="panel-title" aria-hidden="true">
            <div class="panel-title-main">管理員名單</div>
          </div>

          <div class="filters">
            <div class="search-box" role="search">
              <span class="icon" aria-hidden="true">⌕</span>
              <input id="searchInput" class="input" placeholder="搜尋：userId / 名稱" autocomplete="off" />
              <button id="clearSearchBtn" class="btn icon ghost" type="button" aria-label="清除搜尋">✕</button>
            </div>

            <div class="seg" aria-label="審核狀態篩選">
              <button class="chip active" data-filter="ALL" type="button">全部</button>
              <button class="chip" data-filter="通過" type="button">通過</button>
              <button class="chip" data-filter="待審核" type="button">待審核</button>
              <button class="chip" data-filter="拒絕" type="button">拒絕</button>
              <button class="chip" data-filter="停用" type="button">停用</button>
              <button class="chip" data-filter="系統維護" type="button">系統維護</button>
            </div>
          </div>

          <div class="panel-meta">
            <div id="footerStatus" class="hint">-</div>
          </div>

          <div class="panel-actions" aria-label="管理員名單操作">
            <button id="reloadBtn" class="btn ghost" type="button">重新整理</button>
            <button id="saveAllBtn" class="btn primary" type="button" disabled>儲存全部變更</button>
          </div>
        </div>

        <div id="bulkBar" class="bulkbar" hidden>
          <div class="bulk-left">
            <span class="bulk-pill" id="bulkCount">已選取 0 筆</span>
            <button id="bulkClear" class="btn ghost" type="button">清除選取</button>
          </div>
          <div class="bulk-right">
            <div class="bulk-group">
              <label class="bulk-label" for="bulkAudit">批次審核</label>
              <select id="bulkAudit" class="select">
                <option value="">不變更</option>
                <option value="待審核">待審核</option>
                <option value="通過">通過</option>
                <option value="拒絕">拒絕</option>
                <option value="停用">停用</option>
                <option value="系統維護">系統維護</option>
                <option value="其他">其他</option>
              </select>
            </div>

            <button id="bulkApply" class="btn primary" type="button">套用到選取</button>
            <button id="bulkDelete" class="btn danger" type="button">批次刪除</button>
          </div>
        </div>

        <div class="table-wrap responsive-wrap" aria-label="Admins 列表">
          <table class="responsive-table">
            <thead>
              <tr>
                <th class="sticky-col col-check"><input id="checkAll" type="checkbox" aria-label="全選" /></th>
                <th>#</th>

                <!-- 舊欄位 -->
                <th>lineUserId</th>
                <th>lineDisplayName</th>
                <th>審核狀態</th>
                <th>建立時間</th>
                <th>最後登入</th>

                <!-- 新欄位（接在後面） -->
                <th>推播功能開通</th>
                <th>技師審核狀態</th>
                <th>技師建立時間</th>
                <th>技師開始使用日期</th>
                <th>技師使用期限</th>
                <th>技師師傅編號</th>
                <th>技師是否師傅</th>
                <th>技師是否推播</th>
                <th>技師個人狀態開通</th>
                <th>技師排班表開通</th>

                <th class="sticky-right">操作</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="18">載入中...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- ✅ 管理員紀錄（僅顯示 ts / actorUserId / actorDisplayName） -->
      <section id="adminLogsPanelSection" class="panel" aria-label="管理員紀錄" hidden>
        <div class="panel-head">
          <div class="panel-title" aria-hidden="true">
            <div class="panel-title-main">管理員紀錄</div>
          </div>

          <div class="panel-meta" aria-label="管理員紀錄日期">
            <label class="bulk-label" for="logsDateInput">日期</label>
            <input id="logsDateInput" class="select" type="date" />
          </div>

          <div class="panel-meta">
            <div id="logsFooterStatus" class="hint">-</div>
          </div>

          <div class="panel-actions" aria-label="管理員紀錄操作">
            <button id="logsReloadBtn" class="btn ghost" type="button">重新整理</button>
          </div>
        </div>

        <div class="table-wrap responsive-wrap" aria-label="管理員紀錄列表">
          <table class="responsive-table">
            <thead>
              <tr>
                <th>#</th>
                <th>ts</th>
                <th>actorUserId</th>
                <th>actorDisplayName</th>
              </tr>
            </thead>
            <tbody id="logsTbody">
              <tr><td colspan="4">等待管理員驗證後載入...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- KPI (Users/技師名單 - match client) -->
      <section id="usersKpiSection" class="kpi-grid" aria-label="技師統計資訊" hidden>
        <div class="kpi-card">
          <div class="kpi-label">總技師</div>
          <div class="kpi-value" id="uKpiTotal">-</div>
        </div>
        <div class="kpi-card success">
          <div class="kpi-label">通過</div>
          <div class="kpi-value" id="uKpiApproved">-</div>
        </div>
        <div class="kpi-card warning">
          <div class="kpi-label">待審核</div>
          <div class="kpi-value" id="uKpiPending">-</div>
        </div>
        <div class="kpi-card danger">
          <div class="kpi-label">拒絕</div>
          <div class="kpi-value" id="uKpiRejected">-</div>
        </div>
        <div class="kpi-card muted">
          <div class="kpi-label">停用</div>
          <div class="kpi-value" id="uKpiDisabled">-</div>
        </div>
        <div class="kpi-card maintenance">
          <div class="kpi-label">系統維護</div>
          <div class="kpi-value" id="uKpiMaintenance">-</div>
        </div>
      </section>

      <!-- ✅ Users/技師資料管理：直接在 admin 內製作（不嵌入、不外連） -->
      <section id="usersPanelSection" class="panel client-scope" aria-label="Users/技師資料管理" hidden>
        <div class="panel-head">
          <div class="panel-title" aria-hidden="true">
            <div class="panel-title-main">技師名單</div>
          </div>

          <div class="filters">
            <div class="search-box" role="search">
              <span class="icon" aria-hidden="true">⌕</span>
              <input
                id="uSearchInput"
                class="input"
                placeholder="搜尋：userId、名稱、師傅編號"
                autocomplete="off"
              />
              <button id="uClearSearchBtn" class="btn icon ghost" type="button" aria-label="清除搜尋">✕</button>
            </div>

            <div class="seg" aria-label="使用者審核狀態篩選">
              <button class="u-chip active" data-filter="ALL" type="button">全部</button>
              <button class="u-chip" data-filter="通過" type="button">通過</button>
              <button class="u-chip" data-filter="待審核" type="button">待審核</button>
              <button class="u-chip" data-filter="拒絕" type="button">拒絕</button>
              <button class="u-chip" data-filter="停用" type="button">停用</button>
              <button class="u-chip" data-filter="系統維護" type="button">系統維護</button>
            </div>
          </div>

          <div class="panel-actions">
            <button id="uReloadBtn" class="btn ghost" type="button">重新整理 Users</button>
            <button id="uSaveAllBtn" class="btn primary" type="button" disabled>儲存 Users 變更</button>
          </div>
        </div>

        <!-- Bulk bar -->
        <div id="uBulkBar" class="bulkbar" hidden>
          <div class="bulk-left">
            <span class="bulk-pill" id="uBulkCount">已選取 0 筆</span>
            <button id="uBulkClear" class="btn ghost" type="button">清除選取</button>
          </div>

          <div class="bulk-right">
            <div class="bulk-group">
              <label class="bulk-label" for="uBulkAudit">批次審核</label>
              <select id="uBulkAudit" class="select">
                <option value="">不變更</option>
                <option value="待審核">待審核</option>
                <option value="通過">通過</option>
                <option value="拒絕">拒絕</option>
                <option value="停用">停用</option>
                <option value="系統維護">系統維護</option>
                <option value="其他">其他</option>
              </select>
            </div>

            <div class="bulk-group">
              <label class="bulk-label" for="uBulkPush">批次推播</label>
              <select id="uBulkPush" class="select">
                <option value="">不變更</option>
                <option value="是">開啟</option>
                <option value="否">關閉</option>
              </select>
            </div>

            <div class="bulk-group">
              <label class="bulk-label" for="uBulkPersonalStatus">批次個人狀態</label>
              <select id="uBulkPersonalStatus" class="select">
                <option value="">不變更</option>
                <option value="是">開啟</option>
                <option value="否">關閉</option>
              </select>
            </div>

            <div class="bulk-group">
              <label class="bulk-label" for="uBulkScheduleEnabled">批次排班表</label>
              <select id="uBulkScheduleEnabled" class="select">
                <option value="">不變更</option>
                <option value="是">開啟</option>
                <option value="否">關閉</option>
              </select>
            </div>

            <div class="bulk-group">
              <label class="bulk-label" for="uBulkUsageDays">批次期限(天)</label>
              <input id="uBulkUsageDays" class="select" type="number" min="1" placeholder="不變更" />
            </div>

            <div class="bulk-group">
              <label class="bulk-label" for="uBulkStartDate">批次開始使用</label>
              <input id="uBulkStartDate" class="select" type="date" />
            </div>

            <button id="uBulkApply" class="btn primary" type="button">套用到選取</button>
            <button id="uBulkDelete" class="btn danger" type="button">批次刪除</button>
          </div>
        </div>

        <!-- Table -->
        <div class="table-wrap" aria-label="使用者列表（可編輯）">
          <table id="uUsersTable">
            <thead>
              <tr>
                <th class="sticky-col col-check"><input id="uCheckAll" type="checkbox" aria-label="全選" /></th>
                <th>#</th>
                <th>userId</th>
                <th>顯示名稱</th>
                <th>建立時間</th>
                <th>開始使用</th>
                <th>期限(天)</th>
                <th>使用狀態</th>
                <th>審核狀態</th>
                <th>師傅編號</th>
                <th>是否師傅</th>
                <th>是否推播</th>
                <th>個人狀態開通</th>
                <th>排班表開通</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="uTbody">
              <tr><td colspan="15">等待管理員驗證後載入...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- ✅ 技師使用紀錄（僅顯示 serverTime / userId / name / detail） -->
      <section id="techUsageLogsPanelSection" class="panel" aria-label="技師使用紀錄" hidden>
        <div class="panel-head">
          <div class="panel-title" aria-hidden="true">
            <div class="panel-title-main">技師使用紀錄</div>
          </div>

          <div class="panel-meta" aria-label="技師使用紀錄日期">
            <label class="bulk-label" for="techLogsDateInput">日期</label>
            <input id="techLogsDateInput" class="select" type="date" />
          </div>

          <div class="panel-meta">
            <div id="techLogsFooterStatus" class="hint">-</div>
          </div>

          <div class="panel-actions" aria-label="技師使用紀錄操作">
            <button id="techLogsReloadBtn" class="btn ghost" type="button">重新整理</button>
          </div>
        </div>

        <div class="table-wrap responsive-wrap" aria-label="技師使用紀錄列表">
          <table class="responsive-table">
            <thead>
              <tr>
                <th>#</th>
                <th>serverTime</th>
                <th>userId</th>
                <th>name</th>
                <th>detail</th>
              </tr>
            </thead>
            <tbody id="techLogsTbody">
              <tr><td colspan="5">等待管理員驗證後載入...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

    </div>
  </div>

  <div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- ✅ 無權限擋頁 Overlay -->
  <div id="blocker" class="blocker" hidden>
    <div class="blocker-card" role="dialog" aria-modal="true" aria-labelledby="blockerTitle">
      <div class="blocker-badge">ACCESS</div>
      <h2 id="blockerTitle" class="blocker-title">無權限使用</h2>
      <p id="blockerMsg" class="blocker-msg">
        你的 LINE 帳號不在管理者清單中，請聯絡系統管理員。
      </p>

      <div class="blocker-meta" id="blockerMeta">-</div>

      <div class="blocker-actions">
        <button id="btnCopyUserId" class="btn primary" type="button">複製 userId</button>
        <button id="btnCloseLiff" class="btn danger" type="button">關閉</button>
      </div>
    </div>
  </div>

  <!-- 拆分後的 JS（使用 defer 並依序載入，確保相依性正確） -->
  <script src="js/admin.constants.js" defer></script>
  <script src="js/admin.state.js" defer></script>
  <script src="js/admin.utils.js" defer></script>
  <script src="js/admin.data.js" defer></script>
  <script src="js/admin.api.js" defer></script>
  <script src="js/admin.ui.js" defer></script>
  <script src="js/admin.features.js" defer></script>

  <!-- 管理員紀錄（GAS UsageLog） -->
  <script src="js/admin.logs.js" defer></script>

  <!-- 技師使用紀錄（GAS usage_log） -->
  <script src="js/admin.techUsageLogs.js" defer></script>

  <!-- Users/技師資料管理（獨立區塊，不影響原本 admin 清單） -->
  <script src="js/admin.users.js" defer></script>

  <!-- 入口檔（DOMContentLoaded 初始化） -->
  <script src="js/admin.js" defer></script>
</body>
</html>
