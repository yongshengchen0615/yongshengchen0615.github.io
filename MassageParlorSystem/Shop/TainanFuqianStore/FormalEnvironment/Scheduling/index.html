<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Body & Foot Panel Dashboard</title>

  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="data:," />

  <!-- Start fetching the module graph earlier (reduce waterfall) -->
  <link rel="modulepreload" href="js/app.js" />

  <!-- Network hints (reduce first-request DNS/TLS latency) -->
  <link rel="preconnect" href="https://script.google.com" crossorigin="anonymous" />
  <link rel="preconnect" href="https://static.line-scdn.net" crossorigin="anonymous" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin="anonymous" />

  <!-- LIFF SDK -->
  <script defer src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <!-- 授權 / 判斷登入 / 審核狀態遮罩 -->
  <div id="gate" class="gate gate-hidden">
    初始化中…
  </div>

  <!-- 初始資料載入遮罩：資料抓取完成後才會移除 -->
  <div id="initialLoading" class="initial-loading initial-loading-hidden">
    <div class="initial-loading-inner" role="status" aria-live="polite">
      <div class="spinner-lg" aria-hidden="true"></div>
      <p id="initialLoadingText" class="initial-loading-text">資料載入中…</p>
      <div class="initial-loading-progress" role="progressbar" aria-label="載入進度" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div id="initialLoadingBar" class="initial-loading-progress-bar" style="width:0%"></div>
      </div>
      <div id="initialLoadingPercent" class="initial-loading-percent">0%</div>
    </div>
  </div>

  <!-- ✅ Top Loading Hint：不影響面板排列（fixed toast） -->
  <div id="topLoading" class="top-loading hidden" aria-live="polite" aria-atomic="true">
    <span class="top-loading-spinner" aria-hidden="true"></span>
    <span class="top-loading-text">資料載入中…</span>
  </div>

  <!-- 主畫面 -->
  <div id="appRoot" class="app-root app-hidden">
    <div class="layout">
      <!-- ✅ 頁面標題（置頂置中） -->
      <header class="page-title">
        <h1 class="app-title">府前店排班行動版</h1>
        <p class="app-subtitle">即時監控身體 / 腳底師傅狀態與剩餘時間</p>
      </header>

      <!-- 🔔 使用者名稱 + 剩餘天數橫幅（移至控制列上方） -->
      <div id="usageBanner" class="usage-banner" style="display:none;">
        <span id="usageBannerText"></span>
        <button id="btnTopup" class="btn btn-ghost btn-usage-topup" type="button" style="display:none;">💳 儲值</button>
      </div>

      <!-- ✅ 未開通功能提示 -->
      <div id="featureBanner" class="feature-banner">
        <span class="feature-title">未開通功能：</span>
        <div id="featureChips" class="feature-chips"></div>
      </div>

      <!-- 連線狀態 / 深色 / 手動重整 -->
      <header class="app-header">
        <div class="app-header-spacer" aria-hidden="true"></div>

        <div class="app-header-right">
          <div class="pill pill-status">
            <span class="pill-dot"></span>
            <span class="pill-text" id="connectionStatus">已連線（分流 1）</span>
          </div>

          <!-- 常用功能（順序：深色 / 我的狀態 / 排班表 / 手動重整） -->
          <button id="themeToggle" class="btn btn-ghost" type="button">🌙 深色</button>
          <button id="btnMyStatus" class="btn btn-ghost" type="button">🧑‍⚕️ 我的狀態</button>
          <button id="btnSchedule" class="btn btn-ghost" type="button">📋 排班表</button>

          <!-- 其他次要功能保留於同一列，超出時可水平滑動，不會換行 -->
          <button id="btnPerformance" class="btn btn-ghost" type="button">📈 業績</button>
          <button id="btnBooking" class="btn btn-ghost" type="button" style="display:none;">📅 預約查詢</button>
          <button id="btnUserManage" class="btn btn-ghost" type="button">👤 技師管理員</button>
          <button id="btnPersonalStatus" class="btn btn-ghost" type="button">🧑‍⚕️ 技師休假與狀態</button>
        </div>
      </header>

      

      <!-- ✅ 個人狀態快捷按鈕 -->
      <div id="personalTools" class="personal-tools" style="display:none;"></div>

      <!-- ✅ 個人（師傅）身體/腳底狀態 -->
      <div id="myMasterStatus" class="my-master-status" style="display:none;">
        <div class="my-master-title">我的狀態</div>
        <div id="myMasterStatusText" class="my-master-text">—</div>
      </div>

      <!-- Tabs + 篩選列 -->
      <section class="toolbar">
        <div class="tabs">
          <button id="tabBody" class="tab tab-active" type="button">身體面板</button>
          <button id="tabFoot" class="tab" type="button">腳底面板</button>
        </div>

        <div class="filters">
          <div class="filter">
            <label for="filterMaster" class="filter-label">師傅搜尋</label>
            <select id="filterMaster" class="select">
              <option value="">全部師傅</option>
            </select>
          </div>

          <div class="filter">
            <label for="filterStatus" class="filter-label">狀態篩選</label>
            <select id="filterStatus" class="select">
              <option value="all">全部狀態</option>
            </select>
          </div>
        </div>
      </section>

      <!-- 主卡片 + 表格 -->
      <main class="main">
        <section class="card card-table">
          <header class="card-header">
            <div class="card-header-left">
              <h2 id="panelTitle" class="card-title">身體面板</h2>
              <p class="card-subtitle">依「順序」排序，可透過上方下拉選單篩選指定師傅</p>
            </div>

            
            <div class="card-header-right">
              <span id="lastUpdate" class="badge">尚未更新</span>
              <button id="refreshBtn" class="btn btn-ghost" type="button" title="手動重整">🔄 重整排班</button>
            </div>
          </header>

          <div class="card-body">
            <div class="table-wrapper">
              <table class="status-table">
                <thead>
                  <tr>
                    <th style="width: 80px;">順序</th>
                    <th style="width: 80px;">師傅</th>
                    <th style="width: 160px;">狀態</th>
                    <th>預約內容</th>
                    <th style="width: 160px;">剩餘時間</th>
                  </tr>
                </thead>
                <tbody id="tbodyRows"></tbody>
              </table>
            </div>

            <div id="emptyState" class="state state-empty">
              <p>目前沒有任何資料。</p>
            </div>

            <div id="loadingState" class="state state-loading">
              <div class="spinner"></div>
              <p>資料載入中，請稍候…</p>
            </div>

            <div id="errorState" class="state state-error">
              <p>無法取得資料，請稍後再試或使用右上角「手動重整」。</p>
            </div>
          </div>
        </section>
      </main>

      <!-- ✅ 業績 -->
      <section id="perfCard" class="card" style="margin-top:16px;display:none;">
        <header class="card-header">
          <div class="card-header-left">
            <h2 class="card-title">師傅業績</h2>
            <div style="display:flex;flex-direction:column;gap:4px;">
              <p id="perfMeta" class="card-subtitle">—</p>
              <p id="perfMonthRates" class="card-subtitle" style="font-weight:600;">—</p>
            </div>
          </div>
          <div class="card-header-right">
            <span id="perfStatus" class="badge">尚未查詢</span>
            <button id="perfRefreshBtn" class="btn btn-ghost" type="button" title="重整業績">🔄 重整業績</button>
          </div>
        </header>

        <div class="card-body">
          <div class="filters" style="margin-bottom:10px;">
            <div class="filter">
              <label for="perfDateStart" class="filter-label">開始日期</label>
              <input id="perfDateStart" class="input" type="date" lang="en-CA" />
            </div>
            <div class="filter">
              <label for="perfDateEnd" class="filter-label">結束日期</label>
              <input id="perfDateEnd" class="input" type="date" lang="en-CA" />
            </div>
            <div class="filter">
              <label class="filter-label" aria-hidden="true">期別</label>
              <div class="perf-periods">
                <button id="perfPeriodLastMonth" class="btn btn-ghost" type="button">上個月</button>
                <button id="perfPeriodMonth" class="btn btn-ghost" type="button">本月</button>
                <button id="perfPeriodPrev" class="btn btn-ghost" type="button">上期</button>
                <button id="perfPeriodThis" class="btn btn-ghost" type="button">本期</button>
              </div>
            </div>
            <div class="filter">
              <label class="filter-label" aria-hidden="true">&nbsp;</label>
              <div class="perf-actions">
                <button id="perfSearchSummary" class="btn btn-ghost" type="button">業績統計</button>
                <button id="perfSearchDetail" class="btn btn-ghost" type="button">業績明細</button>
              </div>
            </div>
          </div>

          <div class="table-wrapper" style="margin-bottom:12px;">
            <table class="status-table perf-summary-table">
              <thead>
                <tr>
                  <th>類別</th>
                  <th>單數</th>
                  <th>筆數</th>
                  <th>數量</th>
                  <th>金額</th>
                </tr>
              </thead>
              <tbody id="perfSummaryRows">
                <tr><td colspan="5" style="color:var(--text-sub);">請先查詢。</td></tr>
              </tbody>
            </table>
          </div>

          <!-- ✅ Chart Controls -->
          <div class="chart-toolbar" aria-label="圖表工具列">
            <div class="chart-modes" role="group" aria-label="圖表模式">
              <button id="perfChartModeDaily" class="btn btn-ghost btn-chart-mode" type="button" data-mode="daily">日業績</button>
              <button id="perfChartModeCumu"  class="btn btn-ghost btn-chart-mode" type="button" data-mode="cumu">累積</button>
              <button id="perfChartModeMA7"   class="btn btn-ghost btn-chart-mode" type="button" data-mode="ma7">7日均線</button>
                <button id="perfChartModeBar"  class="btn btn-ghost btn-chart-mode" type="button" data-mode="bar">柱狀圖</button>
            </div>
            <button id="perfChartReset" class="btn btn-ghost btn-chart-reset" type="button">↩︎ 重設顯示</button>
          </div>

          <div class="chart-toggle" role="group" aria-label="圖表顯示項目">
            <label class="toggle-chip">
              <input id="perfChartToggleAmount" type="checkbox" checked />
              <span>金額</span>
            </label>

            <label class="toggle-chip">
              <input id="perfChartToggleOldRate" type="checkbox" checked />
              <span>老點率</span>
            </label>

            <label class="toggle-chip">
              <input id="perfChartToggleSchedRate" type="checkbox" checked />
              <span>排班率</span>
            </label>
          </div>

          <div class="chart-wrapper" style="margin:10px 0 12px 0;">
            <canvas id="perfChart" height="160" aria-label="業績趨勢圖表" role="img"></canvas>
          </div>

          <div id="perfChartHint" class="chart-hint" aria-live="polite"></div>

          <div class="table-wrapper">
            <table class="status-table perf-detail-table">
              <thead>
                <tr id="perfDetailHeadRow">
                  <th>服務項目</th>
                  <th>總筆數</th>
                  <th>總節數</th>
                  <th>總計金額</th>
                  <th>老點筆數</th>
                  <th>老點節數</th>
                  <th>老點金額</th>
                  <th>排班筆數</th>
                  <th>排班節數</th>
                  <th>排班金額</th>
                </tr>
              </thead>
              <tbody id="perfDetailRows"></tbody>
            </table>
          </div>

          <div id="perfEmpty" class="state state-empty" style="display:none;">
            <p>查無明細資料。</p>
          </div>

          <div id="perfError" class="state state-error" style="display:none;">
            <p>無法取得業績資料，請稍後再試。</p>
          </div>

          <div style="margin-top:10px;">
            <span id="perfDetailCount" class="badge">0 筆</span>
          </div>
        </div>
      </section>

      <!-- ✅ 預約查詢 -->
      <section id="bookingCard" class="card" style="margin-top:16px;display:none;">
        <header class="card-header">
          <div class="card-header-left">
            <h2 class="card-title">預約查詢</h2>
            <p id="bookingMeta" class="card-subtitle">—</p>
          </div>
          <div class="card-header-right">
            <span id="bookingStatus" class="badge">尚未查詢</span>
          </div>
        </header>

        <div class="card-body">
          <div class="filters" style="margin-bottom:10px;">
            <div class="filter">
              <label for="bookingDateStart" class="filter-label">開始日期</label>
              <input id="bookingDateStart" class="input" type="date" lang="en-CA" />
            </div>
            <div class="filter">
              <label for="bookingDateEnd" class="filter-label">結束日期</label>
              <input id="bookingDateEnd" class="input" type="date" lang="en-CA" />
            </div>
            <div class="filter">
              <label class="filter-label" aria-hidden="true">&nbsp;</label>
              <div class="perf-actions">
                <button id="bookingSearch" class="btn btn-ghost" type="button">查詢</button>
              </div>
            </div>
          </div>

          <div class="table-wrapper">
            <table class="status-table">
              <thead>
                <tr id="bookingHeadRow"></tr>
              </thead>
              <tbody id="bookingRows">
                <tr><td style="color:var(--text-sub);">請先查詢。</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Chart.js is lazy-loaded by performance.js when needed -->
  <script type="module" src="js/app.js"></script>
</body>
</html>
