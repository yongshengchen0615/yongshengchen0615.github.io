// ==UserScript==
// @name         Body & Foot Panel INIT + DIFF + GAS Sync
// @namespace    http://scriptcat.org/
// @version      1.0
// @description  èº«é«” + è…³åº•ï¼šåˆå§‹å…¨é‡å¯«å…¥ + è®Šå‹•æ‰è¼¸å‡ºä¸¦åŒæ­¥ Google Sheetï¼ˆmasterId ç•¶ keyï¼Œå«é¡è‰²ï¼‰
// @match        https://yongshengchen0615.github.io/master.html
// @run-at       document-end
// @grant        none
// ==/UserScript==

(function () {
  'use strict';

  const GAS_URL = "https://script.google.com/macros/s/AKfycbwXwpKPzQFuIWtZOJpeGU9aPbl3RR5bj9yVWjV7mfyYaABaxMetKn_3j_mdMJGN9Ok5Ug/exec";

  console.log("[PanelScan] ðŸŸ¢ å•Ÿå‹• èº«é«” + è…³åº• ç›£æŽ§ (INIT + DIFF)");

  /* ========= å°å·¥å…· ========= */

  function getText(el) {
    if (!el) return "";
    return el.textContent.replace(/\s+/g, "").trim();
  }

  // æŠ“æŸæ ¼è£¡é¢ã€Œç¬¬ä¸€å€‹æœ‰ class çš„ spanã€çš„ className ç•¶é¡è‰²æ¨™è¨˜
  function getFirstSpanClass(el) {
    if (!el) return "";
    const span = el.querySelector("span[class]");
    return span ? span.className.trim() : "";
  }

  // è§£æžä¸€åˆ—ï¼šindex / masterId / status / appointment / remaining + é¡è‰²
  function parseRow(row, panelType) {
    const cells = row.querySelectorAll(":scope > div");
    if (cells.length < 4) return null;

    const indexCell = cells[0];
    const masterCell = cells[1];
    const statusCell = cells[2];
    const appointmentCell = cells[3];

    const indexText = getText(indexCell);
    const masterText = getText(masterCell);
    let statusText = getText(statusCell);
    const appointment = getText(appointmentCell);

    if (!masterText) return null; // æ²’å¸«å‚… ID å°±è·³éŽ

    let remaining = null;

    // ç„¡è«– body / footï¼Œåªè¦ç¬¬ä¸‰æ ¼æ˜¯ç´”æ•¸å­—å°±ç•¶ä½œå‰©é¤˜æ™‚é–“
    if (/^-?\d+$/.test(statusText)) {
      remaining = parseInt(statusText, 10);
      statusText = "å·¥ä½œä¸­";
    }

    const colorIndex = getFirstSpanClass(indexCell);
    const colorMaster = getFirstSpanClass(masterCell);
    const colorStatus = getFirstSpanClass(statusCell);

    return {
      index: indexText ? parseInt(indexText, 10) : null,
      sort: indexText ? parseInt(indexText, 10) : null,
      masterId: masterText || "",
      status: statusText || "",
      appointment: appointment || "",
      remaining: remaining,
      colorIndex,
      colorMaster,
      colorStatus
    };
  }

  // æŽƒæ panelï¼ˆèº«é«” / è…³åº• å…±ç”¨ï¼‰
  function scanPanel(panel, panelType) {
    const rows = panel.querySelectorAll(
      ".flex.justify-center.items-center.flex-1.border-b.border-gray-400"
    );
    const list = [];
    rows.forEach(row => {
      const r = parseRow(row, panelType);
      if (r) list.push(r);
    });
    return list;
  }

  // æ‰¾ã€Œèº«é«”ã€panelï¼ˆmr-2ï¼‰
  function findBodyPanel() {
    const list = document.querySelectorAll("div.flex.flex-col.flex-1.mr-2");
    for (const el of list) {
      const t = el.querySelector("div.flex.justify-center.items-center");
      if (t && t.textContent.includes("èº«é«”")) return el;
    }
    return null;
  }

  // æ‰¾ã€Œè…³åº•ã€panelï¼ˆml-2ï¼‰
  function findFootPanel() {
    const list = document.querySelectorAll("div.flex.flex-col.flex-1.ml-2");
    for (const el of list) {
      const t = el.querySelector("div.flex.justify-center.items-center");
      if (t && t.textContent.includes("è…³åº•")) return el;
    }
    return null;
  }

  /* ========= ç‹€æ…‹å¿«ç…§ ========= */

  // prevStateByType[type] = Map(masterId -> JSON(row))
  const prevStateByType = {
    body: new Map(),
    foot: new Map()
  };
  const initializedByType = {
    body: false,
    foot: false
  };

  function sendToGAS(payload, label) {
    console.log("[PanelScan] ðŸš€ æº–å‚™é€å‡ºåˆ° GAS:", label, payload);

    fetch(GAS_URL, {
      method: "POST",
      mode: "no-cors", // é¿é–‹ CORS
      headers: {
        "Content-Type": "text/plain;charset=utf-8" // é¿å… preflight
      },
      body: JSON.stringify(payload)
    })
      .then(() => {
        console.log(`[PanelScan] ðŸ“¤ ${label} å·²é€å‡º (no-corsï¼Œç„¡æ³•è®€å–å›žæ‡‰)`);
      })
      .catch(err => {
        console.error("[PanelScan] âŒ GAS ç™¼é€éŒ¯èª¤:", err);
      });
  }

  // === INITï¼šç¬¬ä¸€æ¬¡å…¨é‡å¯«å…¥ï¼ˆper typeï¼‰ ===
  function initPanel(panelType, panelEl) {
    const allRows = scanPanel(panelEl, panelType);
    const ts = new Date().toISOString();

    const payload = {
      type: panelType, // "body" / "foot"
      timestamp: ts,
      initial: true,
      rows: allRows.map(r => ({
        timestamp: ts,
        ...r
      }))
    };

    console.log(`[PanelScan] ðŸŸ¡ INITï¼š${panelType} å…¨é‡å¯«å…¥ Google Sheetâ€¦`);
    console.log(payload);

    sendToGAS(payload, `INIT_${panelType}`);

    // å»ºç«‹åˆå§‹å¿«ç…§
    const map = new Map();
    allRows.forEach(r => {
      if (!r.masterId) return;
      map.set(r.masterId, JSON.stringify(r));
    });
    prevStateByType[panelType] = map;
    initializedByType[panelType] = true;
  }

  // === DIFFï¼šæ¯ç§’æª¢æŸ¥è®Šå‹•ï¼ˆper typeï¼‰ ===
  function checkDiff(panelType, panelEl) {
    if (!initializedByType[panelType]) return;

    const now = scanPanel(panelEl, panelType);
    const nowMap = new Map();
    const changed = [];
    const prevMap = prevStateByType[panelType];

    now.forEach(r => {
      if (!r.masterId) return;
      const key = r.masterId;
      const json = JSON.stringify(r);

      nowMap.set(key, json);

      const prev = prevMap.get(key);
      if (!prev || prev !== json) {
        changed.push(r);
      }
    });

    if (changed.length > 0) {
      const ts = new Date().toISOString();

      console.log("-----------------------------------------------------");
      console.log(`[PanelScan] ðŸ” ${panelType} è®Šå‹•ç­†æ•¸ï¼š${changed.length}`);
      console.log(JSON.stringify(changed, null, 2));
      console.log("-----------------------------------------------------");

      const payload = {
        type: panelType,
        timestamp: ts,
        rows: changed.map(r => ({ timestamp: ts, ...r }))
      };

      sendToGAS(payload, `DIFF_${panelType}`);
    }

    prevStateByType[panelType] = nowMap;
  }

  /* ========= å•Ÿå‹•æµç¨‹ ========= */

  function start() {
    const bodyPanel = findBodyPanel();
    const footPanel = findFootPanel();

    if (!bodyPanel && !footPanel) {
      console.log("[PanelScan] âŒ æ‰¾ä¸åˆ° èº«é«” / è…³åº• panelï¼Œ1 ç§’å¾Œé‡è©¦");
      return setTimeout(start, 1000);
    }

    if (bodyPanel) {
      console.log("[PanelScan] âœ… æ‰¾åˆ° èº«é«” panel â†’ INIT");
      initPanel("body", bodyPanel);
    } else {
      console.log("[PanelScan] âš ï¸ æ‰¾ä¸åˆ° èº«é«” panel");
    }

    if (footPanel) {
      console.log("[PanelScan] âœ… æ‰¾åˆ° è…³åº• panel â†’ INIT");
      initPanel("foot", footPanel);
    } else {
      console.log("[PanelScan] âš ï¸ æ‰¾ä¸åˆ° è…³åº• panel");
    }

    setInterval(() => {
      try {
        if (bodyPanel) checkDiff("body", bodyPanel);
        if (footPanel) checkDiff("foot", footPanel);
      } catch (err) {
        console.error("[PanelScan] ðŸ”¥ Diff éŒ¯èª¤:", err);
      }
    }, 1000);
  }

  if (document.readyState === "loading") {
    window.addEventListener("DOMContentLoaded", start);
  } else {
    start();
  }
})();