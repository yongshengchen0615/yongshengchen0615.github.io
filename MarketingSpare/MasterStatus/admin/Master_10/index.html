<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Users å¾Œå°ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-card: #0b1220;
      --bg-soft: #020617;
      --border: #1f2937;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.1);
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.1);
      --success: #4ade80;
      --success-soft: rgba(74, 222, 128, 0.1);
      --warning: #facc15;
      --warning-soft: rgba(250, 204, 21, 0.12);
      --muted: #4b5563;
      --radius-lg: 14px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #020617 100%);
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
      display: flex;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 1120px;
    }

    .card {
      background: var(--bg-card);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 20px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.7);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .title-wrap h1 {
      margin: 0;
      font-size: 20px;
    }

    .title-wrap p {
      margin: 4px 0 0 0;
      font-size: 13px;
      color: var(--text-sub);
    }

    .status-pill {
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--border);
      color: var(--text-sub);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
    }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .search-box {
      flex: 1;
      min-width: 180px;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid var(--border);
      color: var(--text-main);
      font-size: 13px;
    }

    .search-box input {
      flex: 1;
      border: none;
      background: transparent;
      color: inherit;
      font: inherit;
      outline: none;
      min-width: 0;
    }

    .search-box span {
      font-size: 14px;
      color: var(--text-sub);
    }

    .filter-group {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      padding: 4px 10px;
      font-size: 12px;
      color: var(--text-sub);
      cursor: pointer;
      display: inline-flex;
      gap: 6px;
      align-items: center;
      user-select: none;
      white-space: nowrap;
    }

    .chip.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
    }

    .chip.bad {
      border-color: var(--danger);
      background: var(--danger-soft);
      color: var(--danger);
    }

    .chip.good {
      border-color: var(--success);
      background: var(--success-soft);
      color: var(--success);
    }

    .table-wrap {
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #020617;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      min-width: 780px;
    }

    thead {
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #111827;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      color: var(--text-sub);
      font-size: 12px;
    }

    tbody tr:hover {
      background: #020617;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .col-displayName {
      max-width: 220px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      border: 1px solid #374151;
    }

    .badge.pending {
      color: #eab308;
      background: rgba(234, 179, 8, 0.08);
      border-color: rgba(234, 179, 8, 0.55);
    }

    .badge.approved {
      color: #4ade80;
      background: rgba(74, 222, 128, 0.08);
      border-color: rgba(74, 222, 128, 0.55);
    }

    .badge.rejected {
      color: var(--danger);
      background: var(--danger-soft);
      border-color: rgba(248, 113, 113, 0.7);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: currentColor;
    }

    .expiry-pill {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      border: 1px solid #374151;
      color: var(--text-sub);
      background: rgba(15, 23, 42, 0.8);
    }

    .expiry-pill.active {
      color: var(--success);
      border-color: rgba(74, 222, 128, 0.6);
      background: var(--success-soft);
    }

    .expiry-pill.expired {
      color: var(--danger);
      border-color: rgba(248, 113, 113, 0.7);
      background: var(--danger-soft);
    }

    .expiry-pill.unset {
      color: var(--warning);
      border-color: rgba(250, 204, 21, 0.6);
      background: var(--warning-soft);
    }

    .btn {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text-main);
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      user-select: none;
      white-space: nowrap;
    }

    .btn.primary {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
    }

    .btn.danger {
      border-color: var(--danger);
      background: var(--danger-soft);
      color: var(--danger);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .btn-sm {
      padding: 2px 6px;
      font-size: 11px;
    }

    .right {
      text-align: right;
    }

    .empty-state {
      text-align: center;
      padding: 20px;
      color: var(--text-sub);
      font-size: 13px;
      white-space: normal;
    }

    .footer {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-sub);
      flex-wrap: wrap;
      gap: 8px;
    }

    .loading {
      font-size: 12px;
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .loading-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      border: 2px solid rgba(56, 189, 248, 0.4);
      border-top-color: var(--accent);
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ====== è¡¨å–®è¼¸å…¥ ====== */
    .date-input,
    .days-input {
      width: 100%;
      max-width: 130px;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text-main);
      font-size: 12px;
    }

    .date-input:focus,
    .days-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .days-input {
      text-align: right;
    }

    /* ========= ä¸­ç­‰è¢å¹•ï¼ˆå¹³æ¿ï¼‰ ========= */
    @media (max-width: 900px) {
      body {
        padding: 12px;
      }

      .card {
        padding: 16px;
      }

      .card-header {
        align-items: flex-start;
      }

      .title-wrap h1 {
        font-size: 18px;
      }

      .title-wrap p {
        font-size: 12px;
      }

      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-group {
        justify-content: flex-start;
      }
    }

    /* ========= å°è¢å¹•ï¼ˆæ‰‹æ©Ÿï¼‰ ========= */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      .card {
        padding: 14px;
        border-radius: 14px;
      }

      .title-wrap h1 {
        font-size: 17px;
      }

      .status-pill {
        font-size: 11px;
        padding-inline: 8px;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 6px 8px;
      }

      /* æ‰‹æ©Ÿä¸Šéš±è—ã€Œå»ºç«‹æ™‚é–“ / é–‹å§‹ä½¿ç”¨ / ä½¿ç”¨æœŸé™ã€ä¸‰æ¬„ */
      th:nth-child(4),
      td:nth-child(4),
      th:nth-child(5),
      td:nth-child(5),
      th:nth-child(6),
      td:nth-child(6) {
        display: none;
      }

      .footer {
        flex-direction: column;
        align-items: flex-start;
      }

      .footer #footerHint {
        line-height: 1.5;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card">
    <div class="card-header">
      <div class="title-wrap">
        <h1>Users å¾Œå°ç®¡ç†</h1>
        <p>ç®¡ç†è¨»å†Šä½¿ç”¨è€…çš„å¯©æ ¸ç‹€æ…‹èˆ‡ä½¿ç”¨æœŸé™ï¼ˆè³‡æ–™ä¾†è‡ª Google Sheetã€ŒUsersã€å·¥ä½œè¡¨ï¼‰</p>
      </div>
      <div class="status-pill">
        <span class="status-dot"></span>
        <span id="summaryText">è¼‰å…¥ä¸­â€¦</span>
      </div>
    </div>

    <div class="toolbar">
      <div class="search-box">
        <span>ğŸ”</span>
        <input
          id="searchInput"
          type="text"
          placeholder="æœå°‹ userId / é¡¯ç¤ºåç¨±"
        />
      </div>
      <div class="filter-group">
        <button class="chip active" data-status="ALL">å…¨éƒ¨</button>
        <button class="chip good" data-status="é€šé">å·²é€šé</button>
        <button class="chip" data-status="å¾…å¯©æ ¸">å¾…å¯©æ ¸</button>
        <button class="chip bad" data-status="æ‹’çµ•">å·²æ‹’çµ•</button>
      </div>
    </div>

    <div class="table-wrap" id="tableWrap">
      <table>
        <thead>
        <tr>
          <th style="width: 40px;">#</th>
          <th style="min-width: 140px;">userId</th>
          <th style="min-width: 140px;">é¡¯ç¤ºåç¨±</th>
          <th style="min-width: 140px;">å»ºç«‹æ™‚é–“</th>
          <th style="min-width: 140px;">é–‹å§‹ä½¿ç”¨</th>
          <th style="min-width: 90px;">æœŸé™(å¤©)</th>
          <th style="min-width: 140px;">ä½¿ç”¨ç‹€æ…‹</th>
          <th style="min-width: 120px;">å¯©æ ¸ç‹€æ…‹</th>
          <th style="min-width: 180px;" class="right">æ“ä½œ</th>
        </tr>
        </thead>
        <tbody id="tbody">
        <tr>
          <td colspan="9" class="empty-state">
            <span class="loading">
              <span class="loading-dot"></span>
              <span>è³‡æ–™è¼‰å…¥ä¸­â€¦</span>
            </span>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <div class="footer">
      <div id="footerStatus">â€”</div>
      <div id="footerHint">
        æç¤ºï¼š<br/>
        ãƒ»å¯ä»¥åœ¨å¾Œå°ç›´æ¥è¨­å®šã€Œé–‹å§‹ä½¿ç”¨æ—¥æœŸã€èˆ‡ã€Œä½¿ç”¨æœŸé™(å¤©)ã€ï¼ŒæŒ‰ã€Œå„²å­˜æœŸé™ã€å³å¯æ›´æ–°ã€‚<br/>
        ãƒ»éæœŸçš„ä½¿ç”¨è€…æœƒè‡ªå‹•è¢«æ”¹æˆã€Œå¾…å¯©æ ¸ã€ï¼ŒåŒæ™‚é€™è£¡æœƒæ¨™ç¤ºã€Œå·²éæœŸã€ã€‚
      </div>
    </div>
  </div>
</div>

<script>
  // â˜…â˜…â˜… æ›æˆä½ çš„ GAS Web App URL â˜…â˜…â˜…
  const API_BASE_URL =
    "https://script.google.com/macros/s/AKfycbzYgHZiXNKR2EZ5GVAx99ExBuDYVFYOsKmwpxev_i2aivVOwStCG_rHIik6sMuZ4KCf/exec";

  let allUsers = [];
  let filteredUsers = [];
  let currentFilterStatus = "ALL";
  let isLoading = false;

  const tbody = document.getElementById("tbody");
  const summaryText = document.getElementById("summaryText");
  const footerStatus = document.getElementById("footerStatus");
  const searchInput = document.getElementById("searchInput");

  document.addEventListener("DOMContentLoaded", () => {
    bindUI();
    loadUsers();
  });

  function bindUI() {
    searchInput.addEventListener("input", () => {
      applyFilters();
    });

    document.querySelectorAll(".chip[data-status]").forEach((chip) => {
      chip.addEventListener("click", () => {
        document.querySelectorAll(".chip[data-status]").forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        currentFilterStatus = chip.getAttribute("data-status");
        applyFilters();
      });
    });
  }

  async function loadUsers() {
    isLoading = true;
    renderLoading();

    try {
      const url = API_BASE_URL + "?mode=listUsers";
      const res = await fetch(url, { method: "GET" });
      const json = await res.json();

      if (!json.ok) {
        throw new Error(json.error || "API å›å‚³å¤±æ•—");
      }

      allUsers = json.users || [];
      applyFilters();

      const expiredCount = allUsers.filter(u => getExpiryInfo(u).cls === "expired").length;
      summaryText.textContent = `ç¸½å…± ${allUsers.length} ä½ä½¿ç”¨è€…ï¼Œå…¶ä¸­ ${expiredCount} ä½å·²éæœŸ`;
      footerStatus.textContent = `æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š${new Date().toLocaleString()}`;
    } catch (err) {
      console.error(err);
      tbody.innerHTML = `
        <tr>
          <td colspan="9" class="empty-state">
            è®€å–å¤±æ•—ï¼š${err.message || err}
          </td>
        </tr>
      `;
      summaryText.textContent = "è®€å–å¤±æ•—";
    } finally {
      isLoading = false;
    }
  }

  function renderLoading() {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="empty-state">
          <span class="loading">
            <span class="loading-dot"></span>
            <span>è³‡æ–™è¼‰å…¥ä¸­â€¦</span>
          </span>
        </td>
      </tr>
    `;
    summaryText.textContent = "è¼‰å…¥ä¸­â€¦";
  }

  function applyFilters() {
    const keyword = searchInput.value.trim().toLowerCase();

    filteredUsers = allUsers.filter((u) => {
      if (currentFilterStatus !== "ALL") {
        if ((u.audit || "") !== currentFilterStatus) return false;
      }

      if (keyword) {
        const hay = `${u.userId || ""} ${u.displayName || ""}`.toLowerCase();
        if (!hay.includes(keyword)) return false;
      }

      return true;
    });

    renderTable();
  }

  function renderTable() {
    if (!filteredUsers.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="9" class="empty-state">
            æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„ä½¿ç”¨è€…
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = "";
    filteredUsers.forEach((u, idx) => {
      const tr = document.createElement("tr");

      const audit = (u.audit || "").trim();
      const badgeInfo = getBadgeInfo(audit);
      const expiryInfo = getExpiryInfo(u);

      const startDateObj = parseDateTime(u.startDate || "");
      const startDateForInput = startDateObj ? formatDateForInput(startDateObj) : "";

      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${escapeHtml(u.userId || "")}</td>
        <td class="col-displayName">${escapeHtml(u.displayName || "")}</td>
        <td>${escapeHtml(u.createdAt || "")}</td>
        <td>
          <input type="date" class="date-input" value="${startDateForInput}">
        </td>
        <td>
          <input type="number" class="days-input" min="1" step="1" value="${u.usageDays || ""}">
        </td>
        <td>
          <span class="expiry-pill ${expiryInfo.cls}">
            ${escapeHtml(expiryInfo.text)}
          </span>
        </td>
        <td>
          <span class="badge ${badgeInfo.cls}">
            <span class="badge-dot"></span>
            <span>${badgeInfo.text}</span>
          </span>
        </td>
        <td class="right">
          <button class="btn btn-sm" data-action="save-usage">å„²å­˜æœŸé™</button>
          <button class="btn btn-sm primary" data-action="approve">é€šé</button>
          <button class="btn btn-sm" data-action="pending">å¾…å¯©æ ¸</button>
          <button class="btn btn-sm danger" data-action="reject">æ‹’çµ•</button>
        </td>
      `;

      const dateInput = tr.querySelector(".date-input");
      const daysInput = tr.querySelector(".days-input");

      const buttons = tr.querySelectorAll("button[data-action]");
      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const action = btn.getAttribute("data-action");

          if (action === "save-usage") {
            const startValue = dateInput.value; // yyyy-MM-dd
            const daysValue = daysInput.value;
            updateUsage(u.userId, startValue, daysValue);
            return;
          }

          let newStatus = "";
          if (action === "approve") newStatus = "é€šé";
          if (action === "pending") newStatus = "å¾…å¯©æ ¸";
          if (action === "reject") newStatus = "æ‹’çµ•";

          if (!newStatus) return;

          const confirmText = `ç¢ºå®šè¦å°‡ã€Œ${u.displayName || u.userId}ã€çš„å¯©æ ¸ç‹€æ…‹æ”¹ç‚ºã€Œ${newStatus}ã€å—ï¼Ÿ`;
          if (!confirm(confirmText)) return;

          updateUserStatus(u.userId, newStatus);
        });
      });

      tbody.appendChild(tr);
    });
  }

  function getBadgeInfo(audit) {
    if (audit === "é€šé") {
      return { cls: "approved", text: "å·²é€šé" };
    }
    if (audit === "æ‹’çµ•" || audit === "åœç”¨") {
      return { cls: "rejected", text: audit || "å·²æ‹’çµ•" };
    }
    if (audit === "å¾…å¯©æ ¸" || !audit) {
      return { cls: "pending", text: audit || "å¾…å¯©æ ¸" };
    }
    return { cls: "pending", text: audit };
  }

  // è§£æ "yyyy-MM-dd HH:mm:ss" â†’ Date
  function parseDateTime(str) {
    if (!str) return null;
    const m = str.match(
      /^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})$/
    );
    if (!m) return null;
    const year = Number(m[1]);
    const month = Number(m[2]) - 1; // 0-based
    const day = Number(m[3]);
    const hour = Number(m[4]);
    const minute = Number(m[5]);
    const second = Number(m[6]);
    return new Date(year, month, day, hour, minute, second);
  }

  // Date â†’ "yyyy-MM-dd" çµ¦ <input type="date">
  function formatDateForInput(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${da}`;
  }

  // åˆ¤æ–·ä½¿ç”¨ç‹€æ…‹ï¼šä½¿ç”¨ä¸­ / å·²éæœŸ / æœªè¨­å®š
  function getExpiryInfo(u) {
    const startStr = u.startDate;
    const usageRaw = u.usageDays;

    if (!startStr || !usageRaw) {
      return { cls: "unset", text: "æœªè¨­å®š" };
    }

    const usageDays = parseInt(usageRaw, 10);
    if (isNaN(usageDays) || usageDays <= 0) {
      return { cls: "unset", text: "æœªè¨­å®š" };
    }

    const start = parseDateTime(startStr);
    if (!start) {
      return { cls: "unset", text: "æœªè¨­å®š" };
    }

    const msPerDay = 24 * 60 * 60 * 1000;
    const end = new Date(start.getTime() + usageDays * msPerDay);
    const now = new Date();
    const diffMs = end.getTime() - now.getTime();
    const diffDays = Math.ceil(diffMs / msPerDay);

    if (diffDays < 0) {
      return { cls: "expired", text: "å·²éæœŸ" };
    }

    return {
      cls: "active",
      text: `ä½¿ç”¨ä¸­ï¼ˆå‰©é¤˜ ${diffDays} å¤©ï¼‰`
    };
  }

  async function updateUserStatus(userId, newStatus) {
    try {
      footerStatus.textContent = `æ›´æ–°ä¸­ï¼š${userId} â†’ ${newStatus}â€¦`;

      const body = new URLSearchParams();
      body.append("mode", "updateStatus");
      body.append("userId", userId);
      body.append("audit", newStatus);

      const res = await fetch(API_BASE_URL, {
        method: "POST",
        body
      });

      const json = await res.json();
      if (!json.ok) {
        throw new Error(json.error || "API å›å‚³å¤±æ•—");
      }

      allUsers = allUsers.map((u) =>
        u.userId === userId ? { ...u, audit: newStatus } : u
      );

      applyFilters();
      footerStatus.textContent = `å·²æ›´æ–°ï¼š${userId} â†’ ${newStatus}`;
    } catch (err) {
      console.error(err);
      alert("æ›´æ–°å¤±æ•—ï¼š" + (err.message || err));
      footerStatus.textContent = "æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
    }
  }

  async function updateUsage(userId, startDate, usageDays) {
    try {
      footerStatus.textContent = `æ›´æ–°ä½¿ç”¨æœŸé™ä¸­ï¼š${userId}â€¦`;

      const body = new URLSearchParams();
      body.append("mode", "updateUsage");
      body.append("userId", userId);
      body.append("startDate", startDate || "");
      body.append("usageDays", usageDays || "");

      const res = await fetch(API_BASE_URL, {
        method: "POST",
        body
      });

      const json = await res.json();
      if (!json.ok) {
        throw new Error(json.error || "API å›å‚³å¤±æ•—");
      }

      // æˆåŠŸå¾Œé‡æ–°è¼‰å…¥ï¼Œè®“ç‹€æ…‹èˆ‡å‰©é¤˜å¤©æ•¸é‡æ–°è¨ˆç®—
      await loadUsers();
      footerStatus.textContent = `å·²æ›´æ–°ä½¿ç”¨æœŸé™ï¼š${userId}`;
    } catch (err) {
      console.error(err);
      alert("æ›´æ–°ä½¿ç”¨æœŸé™å¤±æ•—ï¼š" + (err.message || err));
      footerStatus.textContent = "æ›´æ–°ä½¿ç”¨æœŸé™å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
    }
  }

  function escapeHtml(str) {
    return String(str || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }
</script>
</body>
</html>
