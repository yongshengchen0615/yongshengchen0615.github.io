<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Users å¾Œå°ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --bg-card: #0b1220;
      --bg-soft: #020617;
      --border: #1f2937;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.1);
      --danger: #f97373;
      --danger-soft: rgba(248, 113, 113, 0.1);
      --success: #4ade80;
      --success-soft: rgba(74, 222, 128, 0.1);
      --warning: #facc15;
      --warning-soft: rgba(250, 204, 21, 0.12);
      --radius-lg: 14px;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #020617 100%);
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
      display: flex;
      justify-content: center;
    }

    .app { width: 100%; max-width: 1120px; }
    .card {
      background: var(--bg-card);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 20px;
      box-shadow: 0 18px 45px rgba(15,23,42,0.6);
    }

    /* ===== æ¨™é¡Œ ===== */
    .card-header {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    .title-wrap h1 { margin: 0; font-size: 20px; }
    .title-wrap p { margin: 4px 0 0; font-size: 13px; color: var(--text-sub); }

    /* ===== æœå°‹ / ç¯©é¸ ===== */
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; }
    .search-box {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--bg);
    }
    .search-box input {
      border: none; background: none; color: var(--text-main);
      flex: 1; outline: none;
    }

    .chip {
      padding: 4px 10px; border-radius: 999px;
      border: 1px solid var(--border); background: #020617;
      color: var(--text-sub); cursor: pointer;
    }
    .chip.active { background: var(--accent-soft); color: var(--accent); border-color: var(--accent); }

    /* ===== è¡¨æ ¼ ===== */
    .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 12px; }
    table { width: 100%; min-width: 900px; border-collapse: collapse; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #111827; white-space: nowrap; }
    th { font-size: 12px; color: var(--text-sub); }

    /* ===== å¯©æ ¸ç‹€æ…‹å¾½ç«  ===== */
    .badge { padding: 3px 8px; border-radius: 999px; display: inline-flex; gap: 6px; font-size: 11px; }
    .badge.approved { color: var(--success); background: var(--success-soft); border: 1px solid var(--success); }
    .badge.pending { color: var(--warning); background: var(--warning-soft); border: 1px solid var(--warning); }
    .badge.rejected { color: var(--danger); background: var(--danger-soft); border: 1px solid var(--danger); }

    /* ===== ä½¿ç”¨æœŸé™ pill ===== */
    .expiry-pill { padding: 3px 8px; border-radius: 999px; font-size: 11px; border: 1px solid #444; }
    .expiry-pill.active { color: var(--success); background: var(--success-soft); border-color: var(--success); }
    .expiry-pill.expired { color: var(--danger); background: var(--danger-soft); border-color: var(--danger); }
    .expiry-pill.unset   { color: var(--warning); background: var(--warning-soft); border-color: var(--warning); }

    /* ===== å¯ç·¨è¼¯ input ===== */
    .date-input,
    .days-input {
      width: 120px;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text-main);
      font-size: 12px;
    }

    /* ===== æŒ‰éˆ• ===== */
    .btn {
      padding: 4px 10px; border-radius: 999px;
      border: 1px solid var(--border); background: #020617;
      color: var(--text-main); font-size: 12px; cursor: pointer;
    }
    .btn.primary { border-color: var(--accent); color: var(--accent); }
    .btn.danger { border-color: var(--danger); color: var(--danger); }
    .btn-sm { padding: 3px 8px; font-size: 11px; }

    /* ===== RWD ä¿®æ­£ï¼šæ‰‹æ©Ÿ===== */
    @media (max-width: 600px) {
      body { padding: 10px; }
      table { font-size: 12px; }

      /* â­ åªéš±è—ã€Œå»ºç«‹æ™‚é–“ã€æ¬„ï¼ˆæ‰‹æ©Ÿå¯ç·¨è¼¯é–‹å§‹æ—¥æœŸèˆ‡ä½¿ç”¨æœŸé™ï¼‰ */
      th:nth-child(4),
      td:nth-child(4) { display: none; }
    }
  </style>
</head>
<body>

<div class="app">
  <div class="card">

    <div class="card-header">
      <div class="title-wrap">
        <h1>Users å¾Œå°ç®¡ç†</h1>
        <p>ç®¡ç†å¯©æ ¸ç‹€æ…‹èˆ‡ä½¿ç”¨æœŸé™</p>
      </div>
      <div id="summaryText">è¼‰å…¥ä¸­...</div>
    </div>

    <div class="toolbar">
      <div class="search-box">
        ğŸ” <input id="searchInput" placeholder="æœå°‹ userId / é¡¯ç¤ºåç¨±" />
      </div>
      <button class="chip active" data-filter="ALL">å…¨éƒ¨</button>
      <button class="chip" data-filter="é€šé">å·²é€šé</button>
      <button class="chip" data-filter="å¾…å¯©æ ¸">å¾…å¯©æ ¸</button>
      <button class="chip" data-filter="æ‹’çµ•">å·²æ‹’çµ•</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>userId</th>
            <th>é¡¯ç¤ºåç¨±</th>
            <th>å»ºç«‹æ™‚é–“</th>
            <th>é–‹å§‹ä½¿ç”¨</th>
            <th>æœŸé™(å¤©)</th>
            <th>ä½¿ç”¨ç‹€æ…‹</th>
            <th>å¯©æ ¸ç‹€æ…‹</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="9">è¼‰å…¥ä¸­...</td></tr>
        </tbody>
      </table>
    </div>

    <div id="footerStatus" style="margin-top:10px; color:#9ca3af;"></div>

  </div>
</div>

<script>
  // â˜… æ›æˆä½ çš„ GAS éƒ¨ç½²ç¶²å€
  const API_BASE_URL = "https://script.google.com/macros/s/AKfycbzYgHZiXNKR2EZ5GVAx99ExBuDYVFYOsKmwpxev_i2aivVOwStCG_rHIik6sMuZ4KCf/exec";

  let allUsers = [];
  let filteredUsers = [];

  document.addEventListener("DOMContentLoaded", () => {
    loadUsers();
    bindFilter();
    document.getElementById("searchInput").addEventListener("input", applyFilters);
  });

  function bindFilter() {
    document.querySelectorAll(".chip").forEach(chip => {
      chip.addEventListener("click", () => {
        document.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        applyFilters();
      });
    });
  }

  /* ===== è®€è³‡æ–™ ===== */
  async function loadUsers() {
    const res = await fetch(API_BASE_URL + "?mode=listUsers");
    const json = await res.json();
    if (!json.ok) return alert("è®€å–å¤±æ•—");
    allUsers = json.users;
    applyFilters();
  }

  /* ===== ç¯©é¸ + æœå°‹ ===== */
  function applyFilters() {
    const keyword = document.getElementById("searchInput").value.toLowerCase();
    const filter = document.querySelector(".chip.active").dataset.filter;

    filteredUsers = allUsers.filter(u => {
      if (filter !== "ALL" && u.audit !== filter) return false;
      if (keyword && !(`${u.userId} ${u.displayName}`.toLowerCase().includes(keyword)))
        return false;
      return true;
    });

    renderTable();
  }

  /* ===== è¡¨æ ¼æ¸²æŸ“ ===== */
  function renderTable() {
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    filteredUsers.forEach((u, i) => {
      const expiry = getExpiryInfo(u);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i + 1}</td>
        <td>${u.userId}</td>
        <td>${u.displayName}</td>
        <td>${u.createdAt}</td>

        <td>
          <input type="date" class="date-input" value="${toInputDate(u.startDate)}">
        </td>

        <td>
          <input type="number" class="days-input" min="1" value="${u.usageDays || ""}">
        </td>

        <td><span class="expiry-pill ${expiry.cls}">${expiry.text}</span></td>

        <td><span class="badge ${badgeCls(u.audit)}">${u.audit}</span></td>

        <td>
          <button class="btn btn-sm" data-act="save">å„²å­˜æœŸé™</button>
          <button class="btn btn-sm primary" data-act="approve">é€šé</button>
          <button class="btn btn-sm" data-act="pending">å¾…å¯©æ ¸</button>
          <button class="btn btn-sm danger" data-act="reject">æ‹’çµ•</button>
        </td>
      `;

      const dateInput = tr.querySelector(".date-input");
      const daysInput = tr.querySelector(".days-input");

      tr.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          const a = btn.dataset.act;
          if (a === "save") {
            updateUsage(u.userId, dateInput.value, daysInput.value);
          } else {
            updateStatus(u.userId, btn.textContent);
          }
        });
      });

      tbody.appendChild(tr);
    });
  }

  /* ===== åˆ¤æ–·ä½¿ç”¨ç‹€æ…‹ ===== */
  function getExpiryInfo(u) {
    if (!u.startDate || !u.usageDays) return { cls: "unset", text: "æœªè¨­å®š" };

    const start = new Date(u.startDate.replace(" ", "T"));
    const end = new Date(start.getTime() + u.usageDays * 86400000);
    const diff = Math.ceil((end - new Date()) / 86400000);

    if (diff < 0) return { cls: "expired", text: "å·²éæœŸ" };
    return { cls: "active", text: `ä½¿ç”¨ä¸­ï¼ˆå‰© ${diff} å¤©ï¼‰` };
  }

  function badgeCls(a) {
    if (a === "é€šé") return "approved";
    if (a === "æ‹’çµ•") return "rejected";
    return "pending";
  }

  function toInputDate(str) {
    if (!str) return "";
    const d = new Date(str.replace(" ", "T"));
    return d.toISOString().slice(0, 10);
  }

  /* ===== æ›´æ–°å¯©æ ¸ç‹€æ…‹ ===== */
  async function updateStatus(id, status) {
    const fd = new URLSearchParams();
    fd.append("mode", "updateStatus");
    fd.append("userId", id);
    fd.append("audit", status);

    await fetch(API_BASE_URL, { method: "POST", body: fd });
    await loadUsers();
  }

  /* ===== æ›´æ–°é–‹å§‹æ—¥æœŸ + ä½¿ç”¨æœŸé™ ===== */
  async function updateUsage(id, date, days) {
    const fd = new URLSearchParams();
    fd.append("mode", "updateUsage");
    fd.append("userId", id);
    fd.append("startDate", date);
    fd.append("usageDays", days);

    await fetch(API_BASE_URL, { method: "POST", body: fd });
    await loadUsers();
  }
</script>

</body>
</html>
