<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>é ç´„è¨­å®šå¾Œå°</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <div class="container">
    <h1>é ç´„è¨­å®šå¾Œå°</h1>

    <!-- å·²æ”¹ç‚ºåœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š ENDPOINT å¸¸æ•¸ï¼Œä¸å†æ–¼ç•«é¢è¼¸å…¥ -->

    <form id="bookingForm">
      <fieldset>
        <legend>ğŸ•’ é ç´„æ™‚é–“è¨­å®š</legend>
        <label>é–‹å§‹æ™‚é–“ï¼š<input type="time" id="startTime" /></label>
        <label>çµæŸæ™‚é–“ï¼š<input type="time" id="endTime" /></label>
      </fieldset>

      <fieldset>
        <legend>â³ é ç´„é™åˆ¶</legend>
        <label>ç•¶å¤©é ç´„éœ€æå‰ï¼ˆåˆ†é˜ï¼‰ï¼š<input type="number" id="bufferMinutes" /></label>
        <label>æœ€å¤šå¯é ç´„å¤©æ•¸ï¼š<input type="number" id="maxBookingDays" /></label>
      </fieldset>

      <fieldset>
        <legend>â›” ä¸­é–“ä¼‘æ¯æ™‚é–“</legend>
        <div id="breakPeriodList"></div>
        <button type="button" onclick="addBreakPeriod()">ï¼‹ æ–°å¢ä¼‘æ¯æ™‚é–“</button>
      </fieldset>

      <fieldset>
        <legend>ğŸ“… æ¯é€±å›ºå®šä¼‘å‡æ—¥</legend>
        <div id="weeklyOffCheckboxes">
          <label><input type="checkbox" value="0" /> é€±æ—¥</label>
          <label><input type="checkbox" value="1" /> é€±ä¸€</label>
          <label><input type="checkbox" value="2" /> é€±äºŒ</label>
          <label><input type="checkbox" value="3" /> é€±ä¸‰</label>
          <label><input type="checkbox" value="4" /> é€±å››</label>
          <label><input type="checkbox" value="5" /> é€±äº”</label>
          <label><input type="checkbox" value="6" /> é€±å…­</label>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
          <button type="button" id="weeklyRefresh">é‡æ–°æ•´ç†æ¯é€±ä¼‘å‡</button>
          <span id="weeklyMsg" class="small"></span>
        </div>
      </fieldset>

      <fieldset>
        <legend>ğŸ“† ç‰¹æ®Šæ—¥æœŸè¨­å®š</legend>

        <div class="date-group">
          <label>å‡æ—¥ï¼š</label>
          <input type="date" id="holidayInput" />
          <button type="button" onclick="addDate('holiday')">æ–°å¢</button>
          <div id="holidayList" class="date-list"></div>
        </div>

        <div class="date-group">
          <label>å°é–æ—¥ï¼š</label>
          <input type="date" id="blockedDayInput" />
          <button type="button" onclick="addDate('blockedDay')">æ–°å¢</button>
          <div id="blockedDayList" class="date-list"></div>
        </div>

        <div class="date-group">
          <label>æ´»å‹•æ—¥ï¼š</label>
          <input type="date" id="eventDayInput" />
          <button type="button" onclick="addDate('eventDay')">æ–°å¢</button>
          <div id="eventDayList" class="date-list"></div>
        </div>

        <div class="date-group">
          <label>åŠå¤©ç‡Ÿæ¥­æ—¥ï¼š</label>
          <input type="date" id="halfDayInput" />
          <button type="button" onclick="addDate('halfDay')">æ–°å¢</button>
          <div id="halfDayList" class="date-list"></div>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
          <button type="button" id="datesRefresh">é‡æ–°æ•´ç†ç‰¹æ®Šæ—¥æœŸ</button>
          <span id="datesMsg" class="small"></span>
        </div>
      </fieldset>

      <button type="submit">ğŸ’¾ å„²å­˜è¨­å®š</button>
    </form>

    <hr />
    <h2>ğŸ› ï¸ æœå‹™é …ç›®ç®¡ç†</h2>

    <select id="serviceTypeSelect">
      <option value="main">ä¸»æœå‹™</option>
      <option value="addon">åŠ è³¼æœå‹™</option>
    </select>

    <div style="display:flex;gap:8px;align-items:center;margin:8px 0;">
      <button id="servicesRefresh" type="button">é‡æ–°æ•´ç†æœå‹™åˆ—è¡¨</button>
      <span id="servicesMsg" class="small"></span>
    </div>
    <div id="serviceList" class="date-group"></div>
    <button id="addServiceBtn" type="button">ï¼‹ æ–°å¢æœå‹™</button>

   <!-- <div id="configDisplay"></div>-->
  </div>
<!-- åˆªé™¤ bookingConfig.js -->
<!-- <script src="js/bookingConfig.js"></script> -->
<!-- ç§»é™¤ä¸å­˜åœ¨çš„æ¨¡çµ„æª”å¼•ç”¨ä»¥é¿å… 404 -->
<script>
  // åœ¨æ­¤ç›´æ¥è¨­å®š Apps Script Web App URLï¼ˆè«‹ä¿®æ”¹ç‚ºä½ çš„ /exec é€£çµï¼‰ï¼š
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwp46vU_Vk_s05D_LTbjAnDfUI4cyEUgQETikt6aIInecfZCAb_RI_vXZUm89GbNhEDgQ/exec';

  function getEndpoint() {
    if (!ENDPOINT || !/^https:\/\/script.google.com\/.+\/exec$/.test(ENDPOINT)) {
      throw new Error('è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®šæ­£ç¢ºçš„ ENDPOINT');
    }
    return ENDPOINT;
  }
  async function apiGet(params) {
    const ep = getEndpoint();
    const url = ep + '?' + new URLSearchParams(params).toString();
    const res = await fetch(url, { method: 'GET' });
    return res.json();
  }
  async function apiPost(payload) {
    const ep = getEndpoint();
    // ä¸è¨­ç½® Content-Type: application/jsonï¼Œé¿å… CORS é æª¢ï¼›Apps Script ä»å¯è®€å– postData.contents
    const res = await fetch(ep, {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    return res.json();
  }

  // ä¸å†éœ€è¦å„²å­˜ URL

  // å°‡ç¾æœ‰è¨­å®šè¡¨å–®é€å‡ºæ™‚ï¼ŒåŒæ­¥å¯«å…¥ Config å·¥ä½œè¡¨
  const bookingForm = document.getElementById('bookingForm');
  bookingForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;
      const bufferMinutes = document.getElementById('bufferMinutes').value;
      const maxBookingDays = document.getElementById('maxBookingDays').value;

      // ä¼‘æ¯æ™‚é–“æ”¶é›†ï¼ˆä»¥ data-break-start/end æ¬„ä½ï¼‰
      const breaks = Array.from(document.querySelectorAll('[data-break-item]')).map(el => ({
        start: el.querySelector('[data-break-start]').value,
        end: el.querySelector('[data-break-end]').value
      })).filter(b => b.start && b.end);

      // weeklyOff å‹¾é¸
      const weeklyChecked = Array.from(document.querySelectorAll('#weeklyOffCheckboxes input[type="checkbox"]'))
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      // é€é …æ›´æ–° Configï¼ˆè‹¥ä¸å­˜åœ¨å‰‡ createï¼Œå­˜åœ¨å‰‡ updateï¼‰
      const upsertConfig = async (key, value) => {
        // å˜—è©¦ updateï¼Œå¤±æ•—å† create
        let res = await apiPost({ entity: 'config', action: 'update', key, data: { Key: key, Value: value } });
        if (!res.ok) {
          res = await apiPost({ entity: 'config', action: 'create', data: { Key: key, Value: value } });
        }
        return res;
      };

      await upsertConfig('startTime', startTime || '');
      await upsertConfig('endTime', endTime || '');
      await upsertConfig('bufferMinutes', String(bufferMinutes || ''));
      await upsertConfig('maxBookingDays', String(maxBookingDays || ''));
      await upsertConfig('breakPeriods', JSON.stringify(breaks));
      await upsertConfig('weeklyOff', JSON.stringify(weeklyChecked));

      alert('å·²å„²å­˜è¨­å®šåˆ° Config å·¥ä½œè¡¨');
    } catch (err) {
      alert('å„²å­˜è¨­å®šå¤±æ•—ï¼š' + String(err));
    }
  });

  // å‹•æ…‹æ–°å¢ä¼‘æ¯æ™‚é–“ UIï¼ˆèˆ‡ç¾æœ‰ addBreakPeriod é€£å‹•ï¼‰
  const breakPeriodList = document.getElementById('breakPeriodList');
  function addBreakRow(start = '', end = '') {
    const row = document.createElement('div');
    row.setAttribute('data-break-item', '1');
    row.style.display = 'flex'; row.style.gap = '8px'; row.style.margin = '6px 0';
    row.innerHTML = `
      <input data-break-start type="time" value="${start}" />
      <input data-break-end type="time" value="${end}" />
      <button type="button">åˆªé™¤</button>
    `;
    row.querySelector('button').addEventListener('click', () => row.remove());
    breakPeriodList.appendChild(row);
  }
  // è‹¥é é¢å·²å®šç¾© addBreakPeriod å‡½å¼ï¼Œå‰‡è¦†è“‹ç‚ºä½¿ç”¨ä¸Šè¿° DOM
  window.addBreakPeriod = function() { addBreakRow(); };

  // DateTypes æ“ä½œçš„ç°¡æ˜“å…¥å£ï¼šå¾é é¢å››ç¨®æ—¥æœŸç¾¤çµ„æŒ‰éˆ•è§¸ç™¼ï¼ˆaddDate(type)ï¼‰
  window.addDate = async function(type) {
    try {
      const map = {
        holiday: 'holidayInput', blockedDay: 'blockedDayInput', eventDay: 'eventDayInput', halfDay: 'halfDayInput'
      };
      const id = map[type];
      if (!id) return alert('æœªçŸ¥é¡å‹');
      const date = document.getElementById(id).value;
      if (!date) return alert('è«‹é¸æ“‡æ—¥æœŸ');
      const res = await apiPost({ entity: 'datetypes', action: 'create', data: { Type: type, Date: date } });
      if (res.ok) alert('å·²æ–°å¢ ' + type + 'ï¼š' + date);
      else alert('æ–°å¢å¤±æ•—ï¼š' + (res.error || ''));
    } catch (err) {
      alert('æ“ä½œå¤±æ•—ï¼š' + String(err));
    }
  };

  // æœå‹™é …ç›®ç®¡ç†ï¼šä¾ç¾æœ‰ UIï¼ˆserviceTypeSelectã€serviceListã€addServiceBtnï¼‰æä¾›ç°¡æ˜“æ–°å¢ä¸»/åŠ è³¼æœå‹™
  const addServiceBtn = document.getElementById('addServiceBtn');
  const servicesMsg = document.getElementById('servicesMsg');
  const servicesRefreshBtn = document.getElementById('servicesRefresh');
  const weeklyRefreshBtn = document.getElementById('weeklyRefresh');
  const weeklyMsg = document.getElementById('weeklyMsg');
  const datesRefreshBtn = document.getElementById('datesRefresh');
  const datesMsg = document.getElementById('datesMsg');
  // ç›´è¦ºçš„æ–°å¢æœå‹™ï¼šä½¿ç”¨é é¢ä¸‹æ–¹çš„è¼¸å…¥è¡¨å–®ï¼ˆå½ˆå‡ºå°è©±æ¡†æ”¹ç‚ºè¡Œå…§è¼¸å…¥ï¼‰
  addServiceBtn.addEventListener('click', async () => {
    try {
      const isAddonType = document.getElementById('serviceTypeSelect').value === 'addon';
      // å»ºç«‹è¡Œå…§è¼¸å…¥åˆ—
      const container = document.getElementById('serviceList');
      const formRow = document.createElement('div');
      formRow.style.display = 'grid';
      formRow.style.gridTemplateColumns = '2fr 1fr 1fr 1fr auto';
      formRow.style.gap = '8px';
      formRow.style.margin = '8px 0';
      formRow.innerHTML = `
        <input type="text" placeholder="æœå‹™åç¨±" />
        <input type="number" placeholder="åˆ†é˜" />
        <input type="number" placeholder="åƒ¹æ ¼" />
        <input type="text" placeholder="åˆ†é¡ï¼ˆä¾‹ï¼šå…¨èº«æŒ‰æ‘©ï¼‰" ${isAddonType ? 'value="åŠ è³¼æœå‹™"' : ''} />
        <button type="button">å„²å­˜</button>
      `;
      const [nameEl, minEl, priceEl, typeEl, saveBtn] = formRow.querySelectorAll('input,button');
      container.prepend(formRow);
      saveBtn.addEventListener('click', async () => {
        const ServiceName = nameEl.value.trim();
        const TimeMinutes = Number(minEl.value || '0');
        const Price = Number(priceEl.value || '0');
        const Type = typeEl.value.trim();
        const IsAddon = isAddonType ? 'TRUE' : 'FALSE';
        if (!ServiceName) return alert('è«‹è¼¸å…¥æœå‹™åç¨±');
        const res = await apiPost({ entity: 'services', action: 'create', data: { ServiceName, TimeMinutes, Price, Type, IsAddon } });
        if (res.ok) { alert('æœå‹™å·²æ–°å¢'); renderServices(); formRow.remove(); }
        else { alert('æ–°å¢å¤±æ•—ï¼š' + (res.error || '')); }
      });
    } catch (err) { alert('æ“ä½œå¤±æ•—ï¼š' + String(err)); }
  });

  // æœå‹™åˆ—è¡¨æ¸²æŸ“ï¼šå¾ services list è®€å–ä¸¦åˆ†é¡å±•ç¤º
  async function renderServices() {
    try {
      const res = await apiGet({ entity: 'services', action: 'list' });
      if (!res.ok) { servicesMsg.textContent = res.error || 'è¼‰å…¥å¤±æ•—'; servicesMsg.className = 'small error'; return; }
      const data = Array.isArray(res.data) ? res.data : [];
      servicesMsg.textContent = `å…± ${data.length} ç­†`; servicesMsg.className = 'small success';
      const container = document.getElementById('serviceList');
      container.innerHTML = '';
      const main = data.filter(d => String(d.IsAddon).toUpperCase() !== 'TRUE');
      const addon = data.filter(d => String(d.IsAddon).toUpperCase() === 'TRUE');
      const section = (title, items) => {
        const wrap = document.createElement('div');
        wrap.style.marginTop = '8px';
        const h = document.createElement('h3'); h.textContent = title; h.style.fontSize = '14px';
        wrap.appendChild(h);
        const table = document.createElement('table');
        table.style.width = '100%'; table.style.borderCollapse = 'collapse';
        table.innerHTML = `<thead><tr>
          <th style="text-align:left;">æœå‹™åç¨±</th>
          <th>åˆ†é˜</th>
          <th>åƒ¹æ ¼</th>
          <th>åˆ†é¡</th>
          <th>æ“ä½œ</th>
        </tr></thead><tbody></tbody>`;
        const tbody = table.querySelector('tbody');
        items.forEach(it => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${it.ServiceName}</td>
            <td>${it.TimeMinutes}</td>
            <td>$${it.Price}</td>
            <td>${it.Type}</td>
            <td>
              <button data-act="edit">ä¿®æ”¹</button>
              <button data-act="del">åˆªé™¤</button>
            </td>`;
          tr.querySelector('[data-act="del"]').addEventListener('click', async () => {
            if (!confirm(`ç¢ºå®šåˆªé™¤ï¼š${it.ServiceName}ï¼Ÿ`)) return;
            const res = await apiPost({ entity: 'services', action: 'delete', key: it.ServiceName });
            if (res.ok) renderServices(); else alert('åˆªé™¤å¤±æ•—ï¼š' + (res.error || ''));
          });
          tr.querySelector('[data-act="edit"]').addEventListener('click', () => {
            // è¡Œå…§ç·¨è¼¯
            const name = prompt('æœå‹™åç¨±', it.ServiceName) || it.ServiceName;
            const minutes = Number(prompt('åˆ†é˜', it.TimeMinutes) || it.TimeMinutes);
            const price = Number(prompt('åƒ¹æ ¼', it.Price) || it.Price);
            const type = prompt('åˆ†é¡', it.Type) || it.Type;
            const payload = { entity: 'services', action: 'update', key: it.ServiceName, data: { ServiceName: name, TimeMinutes: minutes, Price: price, Type: type, IsAddon: String(it.IsAddon).toUpperCase() === 'TRUE' ? 'TRUE' : 'FALSE' } };
            apiPost(payload).then(res => { if (res.ok) renderServices(); else alert('ä¿®æ”¹å¤±æ•—ï¼š' + (res.error || '')); });
          });
          tbody.appendChild(tr);
        });
        wrap.appendChild(table);
        return wrap;
      };
      container.appendChild(section('ä¸»æœå‹™', main));
      container.appendChild(section('åŠ è³¼æœå‹™', addon));
    } catch (err) {
      servicesMsg.textContent = String(err); servicesMsg.className = 'small error';
    }
  }
  servicesRefreshBtn.addEventListener('click', renderServices);

  // æ¯é€±å›ºå®šä¼‘å‡æ¸²æŸ“ï¼šå¾ Config.weeklyOff é å¡«å‹¾é¸ä¸¦é¡¯ç¤ºç­†æ•¸
  async function renderWeeklyOff() {
    try {
      const res = await apiGet({ entity: 'config', action: 'list' });
      if (!res.ok) { weeklyMsg.textContent = res.error || 'è¼‰å…¥å¤±æ•—'; weeklyMsg.className = 'small error'; return; }
      const offs = (() => { try { return JSON.parse(res.data.weeklyOff || '[]'); } catch { return []; } })();
      const boxes = Array.from(document.querySelectorAll('#weeklyOffCheckboxes input[type="checkbox"]'));
      boxes.forEach(cb => { cb.checked = offs.includes(cb.value); });
      weeklyMsg.textContent = `ç›®å‰è¨­å®šï¼š${offs.join(', ') || 'ï¼ˆç„¡ï¼‰'}`; weeklyMsg.className = 'small success';
    } catch (err) {
      weeklyMsg.textContent = String(err); weeklyMsg.className = 'small error';
    }
  }
  weeklyRefreshBtn.addEventListener('click', renderWeeklyOff);

  // ç‰¹æ®Šæ—¥æœŸæ¸²æŸ“ï¼šè®€å– datetypesï¼Œä¾ Type é¡åˆ¥åˆ†çµ„é¡¯ç¤º
  async function renderDateTypes() {
    try {
      const res = await apiGet({ entity: 'datetypes', action: 'list' });
      if (!res.ok) { datesMsg.textContent = res.error || 'è¼‰å…¥å¤±æ•—'; datesMsg.className = 'small error'; return; }
      const data = Array.isArray(res.data) ? res.data : [];
      datesMsg.textContent = `å…± ${data.length} ç­†`; datesMsg.className = 'small success';
      const byType = (t) => data.filter(r => r.Type === t);
      const renderList = (id, items, type) => {
        const el = document.getElementById(id);
        el.innerHTML = '';
        if (!items.length) { el.textContent = 'ï¼ˆç„¡ï¼‰'; return; }
        const table = document.createElement('table');
        table.style.width = '100%'; table.style.borderCollapse = 'collapse';
        table.innerHTML = `<thead><tr><th style="text-align:left;">æ—¥æœŸ</th><th>æ“ä½œ</th></tr></thead><tbody></tbody>`;
        const tbody = table.querySelector('tbody');
        items.forEach(({ Date }) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${Date}</td><td><button data-act="del">åˆªé™¤</button></td>`;
          tr.querySelector('[data-act="del"]').addEventListener('click', async () => {
            if (!confirm(`ç¢ºå®šåˆªé™¤ï¼š${type} ${Date}ï¼Ÿ`)) return;
            const res = await apiPost({ entity: 'datetypes', action: 'delete', key: { Type: type, Date } });
            if (res.ok) renderDateTypes(); else alert('åˆªé™¤å¤±æ•—ï¼š' + (res.error || ''));
          });
          tbody.appendChild(tr);
        });
        el.appendChild(table);
      };
      renderList('holidayList', byType('holiday'), 'holiday');
      renderList('blockedDayList', byType('blockedDay'), 'blockedDay');
      renderList('eventDayList', byType('eventDay'), 'eventDay');
      renderList('halfDayList', byType('halfDay'), 'halfDay');
    } catch (err) {
      datesMsg.textContent = String(err); datesMsg.className = 'small error';
    }
  }
  datesRefreshBtn.addEventListener('click', renderDateTypes);

  // ç°¡æ˜“ï¼šè¼‰å…¥ Config ä»¥é å¡« UI
  (async function preloadConfig() {
    try {
      // è‹¥ ENDPOINT æœªè¨­å®šå‰‡ä¸è¼‰å…¥
      if (!ENDPOINT) return;
      const res = await apiGet({ entity: 'config', action: 'list' });
      if (res.ok && res.data) {
        const cfg = res.data;
        // å°‡å¯èƒ½ç‚ºæ—¥æœŸå­—ä¸²çš„æ™‚é–“è½‰ç‚º HH:mm
        const toHHMM = (val) => {
          if (!val) return '';
          // è‹¥ç‚º "HH:mm" ç›´æ¥ä½¿ç”¨
          if (/^\d{2}:\d{2}(:\d{2}(\.\d{3})?)?$/.test(val)) return val.slice(0,5);
          try {
            const d = new Date(val);
            if (!isNaN(d.getTime())) {
              const hh = String(d.getHours()).padStart(2,'0');
              const mm = String(d.getMinutes()).padStart(2,'0');
              return `${hh}:${mm}`;
            }
          } catch {}
          return '';
        };
        if (cfg.startTime) document.getElementById('startTime').value = toHHMM(cfg.startTime);
        if (cfg.endTime) document.getElementById('endTime').value = toHHMM(cfg.endTime);
        if (cfg.bufferMinutes) document.getElementById('bufferMinutes').value = Number(cfg.bufferMinutes);
        if (cfg.maxBookingDays) document.getElementById('maxBookingDays').value = Number(cfg.maxBookingDays);
        if (cfg.breakPeriods) {
          try { JSON.parse(cfg.breakPeriods).forEach(b => addBreakRow(b.start, b.end)); } catch {}
        }
        if (cfg.weeklyOff) {
          try {
            const offs = JSON.parse(cfg.weeklyOff);
            Array.from(document.querySelectorAll('#weeklyOffCheckboxes input[type="checkbox"]')).forEach(cb => {
              cb.checked = offs.includes(cb.value);
            });
          } catch {}
        }
      }
      // åˆæ¬¡è¼‰å…¥åŒæ™‚æ¸²æŸ“ä¸‰å€å¡Š
      renderWeeklyOff();
      renderDateTypes();
      renderServices();
    } catch {}
  })();
</script>
</body>
</html>
