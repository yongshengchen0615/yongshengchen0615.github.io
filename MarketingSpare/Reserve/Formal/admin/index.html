<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>é ç´„è¨­å®šå¾Œå°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h3 mb-0">é ç´„è¨­å®šå¾Œå°</h1>
      <div class="d-flex align-items-center gap-2">
        <label class="form-check form-switch mb-0" title="åˆ‡æ›äº®/æš—è‰²èª¿">
          <input class="form-check-input" type="checkbox" id="themeToggle" />
          <span class="form-check-label">æš—è‰²æ¨¡å¼</span>
        </label>
      </div>
    </div>

    <!-- å·²æ”¹ç‚ºåœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®š ENDPOINT å¸¸æ•¸ï¼Œä¸å†æ–¼ç•«é¢è¼¸å…¥ -->

    <form id="bookingForm" class="needs-validation" novalidate>
      <fieldset class="border rounded-3 p-3 mb-3">
        <legend class="float-none w-auto px-2">ğŸ•’ é ç´„æ™‚é–“è¨­å®š</legend>
        <div class="row g-3">
          <div class="col-sm-6">
            <label for="startTime" class="form-label">é–‹å§‹æ™‚é–“</label>
            <input type="time" id="startTime" class="form-control" />
          </div>
          <div class="col-sm-6">
            <label for="endTime" class="form-label">çµæŸæ™‚é–“</label>
            <input type="time" id="endTime" class="form-control" />
          </div>
        </div>
      </fieldset>

      <fieldset class="border rounded-3 p-3 mb-3">
        <legend class="float-none w-auto px-2">â³ é ç´„é™åˆ¶</legend>
        <div class="row g-3">
          <div class="col-sm-6">
            <label for="bufferMinutes" class="form-label">ç•¶å¤©é ç´„éœ€æå‰ï¼ˆåˆ†é˜ï¼‰</label>
            <input type="number" id="bufferMinutes" class="form-control" />
          </div>
          <div class="col-sm-6">
            <label for="maxBookingDays" class="form-label">æœ€å¤šå¯é ç´„å¤©æ•¸</label>
            <input type="number" id="maxBookingDays" class="form-control" />
          </div>
        </div>
      </fieldset>

      <fieldset class="border rounded-3 p-3 mb-3">
        <legend class="float-none w-auto px-2">â›” ä¸­é–“ä¼‘æ¯æ™‚é–“</legend>
        <div id="breakPeriodList" class="mb-2"></div>
        <button type="button" class="btn btn-primary btn-sm soft" onclick="addBreakPeriod()">ï¼‹ æ–°å¢ä¼‘æ¯æ™‚é–“</button>
      </fieldset>

      <fieldset class="border rounded-3 p-3 mb-3">
        <legend class="float-none w-auto px-2">ğŸ“… æ¯é€±å›ºå®šä¼‘å‡æ—¥</legend>
        <div id="weeklyOffCheckboxes" class="d-flex flex-wrap gap-3">
          <label class="form-check"><input class="form-check-input" type="checkbox" value="0" /><span class="form-check-label"> é€±æ—¥</span></label>
          <label class="form-check"><input class="form-check-input" type="checkbox" value="1" /><span class="form-check-label"> é€±ä¸€</span></label>
          <label class="form-check"><input class="form-check-input" type="checkbox" value="2" /><span class="form-check-label"> é€±äºŒ</span></label>
          <label class="form-check"><input class="form-check-input" type="checkbox" value="3" /><span class="form-check-label"> é€±ä¸‰</span></label>
          <label class="form-check"><input class="form-check-input" type="checkbox" value="4" /><span class="form-check-label"> é€±å››</span></label>
          <label class="form-check"><input class="form-check-input" type="checkbox" value="5" /><span class="form-check-label"> é€±äº”</span></label>
          <label class="form-check"><input class="form-check-input" type="checkbox" value="6" /><span class="form-check-label"> é€±å…­</span></label>
        </div>
        <div class="mt-2 d-flex align-items-center gap-2">
          <button type="button" class="btn btn-secondary btn-sm soft" id="weeklyRefresh">é‡æ–°æ•´ç†æ¯é€±ä¼‘å‡</button>
          <span id="weeklyMsg" class="small"></span>
        </div>
      </fieldset>

      <fieldset class="border rounded-3 p-3 mb-3">
        <legend class="float-none w-auto px-2">ğŸ“† ç‰¹æ®Šæ—¥æœŸè¨­å®š</legend>

        <div class="date-group mb-3">
          <label class="form-label">å‡æ—¥</label>
          <div class="d-flex gap-2">
            <input type="date" id="holidayInput" class="form-control" />
            <button type="button" class="btn btn-primary soft" onclick="addDate('holiday')">æ–°å¢</button>
          </div>
          <div id="holidayList" class="date-list mt-2"></div>
        </div>

        <div class="date-group mb-3">
          <label class="form-label">å°é–æ—¥</label>
          <div class="d-flex gap-2">
            <input type="date" id="blockedDayInput" class="form-control" />
            <button type="button" class="btn btn-primary soft" onclick="addDate('blockedDay')">æ–°å¢</button>
          </div>
          <div id="blockedDayList" class="date-list mt-2"></div>
        </div>

        <div class="date-group mb-3">
          <label class="form-label">æ´»å‹•æ—¥</label>
          <div class="d-flex gap-2">
            <input type="date" id="eventDayInput" class="form-control" />
            <button type="button" class="btn btn-primary soft" onclick="addDate('eventDay')">æ–°å¢</button>
          </div>
          <div id="eventDayList" class="date-list mt-2"></div>
        </div>

        <div class="date-group mb-3">
          <label class="form-label">åŠå¤©ç‡Ÿæ¥­æ—¥</label>
          <div class="d-flex gap-2">
            <input type="date" id="halfDayInput" class="form-control" />
            <button type="button" class="btn btn-primary soft" onclick="addDate('halfDay')">æ–°å¢</button>
          </div>
          <div id="halfDayList" class="date-list mt-2"></div>
        </div>

        <div class="mt-2 d-flex align-items-center gap-2">
          <button type="button" class="btn btn-secondary btn-sm soft" id="datesRefresh">é‡æ–°æ•´ç†ç‰¹æ®Šæ—¥æœŸ</button>
          <span id="datesMsg" class="small"></span>
        </div>
      </fieldset>

      <button type="submit" class="btn btn-success soft">ğŸ’¾ å„²å­˜è¨­å®š</button>
    </form>

    <hr class="my-4" />
    <h2 class="h4 mb-3">ğŸ› ï¸ æœå‹™é …ç›®ç®¡ç†</h2>

    <select id="serviceTypeSelect" class="form-select w-auto">
      <option value="main">ä¸»æœå‹™</option>
      <option value="addon">åŠ è³¼æœå‹™</option>
    </select>

    <div class="d-flex align-items-center gap-2 my-2">
      <button id="servicesRefresh" type="button" class="btn btn-secondary btn-sm soft">é‡æ–°æ•´ç†æœå‹™åˆ—è¡¨</button>
      <span id="servicesMsg" class="small"></span>
    </div>
    <div id="serviceList" class="date-group"></div>
    <button id="addServiceBtn" type="button" class="btn btn-primary mt-2 soft">ï¼‹ æ–°å¢æœå‹™</button>

   <!-- <div id="configDisplay"></div>-->
  </div>
<!-- åˆªé™¤ bookingConfig.js -->
<!-- <script src="js/bookingConfig.js"></script> -->
<!-- ç§»é™¤ä¸å­˜åœ¨çš„æ¨¡çµ„æª”å¼•ç”¨ä»¥é¿å… 404 -->
<script>
  // åœ¨æ­¤ç›´æ¥è¨­å®š Apps Script Web App URLï¼ˆè«‹ä¿®æ”¹ç‚ºä½ çš„ /exec é€£çµï¼‰ï¼š
  const ENDPOINT = 'https://script.google.com/macros/s/AKfycbwp46vU_Vk_s05D_LTbjAnDfUI4cyEUgQETikt6aIInecfZCAb_RI_vXZUm89GbNhEDgQ/exec';

  function getEndpoint() {
    if (!ENDPOINT || !/^https:\/\/script.google.com\/.+\/exec$/.test(ENDPOINT)) {
      throw new Error('è«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®šæ­£ç¢ºçš„ ENDPOINT');
    }
    return ENDPOINT;
  }
  async function apiGet(params) {
    const ep = getEndpoint();
    const url = ep + '?' + new URLSearchParams(params).toString();
    const res = await fetch(url, { method: 'GET' });
    return res.json();
  }
  async function apiPost(payload) {
    const ep = getEndpoint();
    // ä¸è¨­ç½® Content-Type: application/jsonï¼Œé¿å… CORS é æª¢ï¼›Apps Script ä»å¯è®€å– postData.contents
    const res = await fetch(ep, {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    return res.json();
  }

  // ä¸å†éœ€è¦å„²å­˜ URL

  // å°‡ç¾æœ‰è¨­å®šè¡¨å–®é€å‡ºæ™‚ï¼ŒåŒæ­¥å¯«å…¥ Config å·¥ä½œè¡¨
  const bookingForm = document.getElementById('bookingForm');
  bookingForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;
      const bufferMinutes = document.getElementById('bufferMinutes').value;
      const maxBookingDays = document.getElementById('maxBookingDays').value;

      // ä¼‘æ¯æ™‚é–“æ”¶é›†ï¼ˆä»¥ data-break-start/end æ¬„ä½ï¼‰
      const breaks = Array.from(document.querySelectorAll('[data-break-item]')).map(el => ({
        start: el.querySelector('[data-break-start]').value,
        end: el.querySelector('[data-break-end]').value
      })).filter(b => b.start && b.end);

      // weeklyOff å‹¾é¸
      const weeklyChecked = Array.from(document.querySelectorAll('#weeklyOffCheckboxes input[type="checkbox"]'))
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      // é€é …æ›´æ–° Configï¼ˆè‹¥ä¸å­˜åœ¨å‰‡ createï¼Œå­˜åœ¨å‰‡ updateï¼‰
      const upsertConfig = async (key, value) => {
        // å˜—è©¦ updateï¼Œå¤±æ•—å† create
        let res = await apiPost({ entity: 'config', action: 'update', key, data: { Key: key, Value: value } });
        if (!res.ok) {
          res = await apiPost({ entity: 'config', action: 'create', data: { Key: key, Value: value } });
        }
        return res;
      };

      await upsertConfig('startTime', startTime || '');
      await upsertConfig('endTime', endTime || '');
      await upsertConfig('bufferMinutes', String(bufferMinutes || ''));
      await upsertConfig('maxBookingDays', String(maxBookingDays || ''));
      await upsertConfig('breakPeriods', JSON.stringify(breaks));
      await upsertConfig('weeklyOff', JSON.stringify(weeklyChecked));

      alert('å·²å„²å­˜è¨­å®šåˆ° Config å·¥ä½œè¡¨');
    } catch (err) {
      alert('å„²å­˜è¨­å®šå¤±æ•—ï¼š' + String(err));
    }
  });

  // å‹•æ…‹æ–°å¢ä¼‘æ¯æ™‚é–“ UIï¼ˆèˆ‡ç¾æœ‰ addBreakPeriod é€£å‹•ï¼‰
  const breakPeriodList = document.getElementById('breakPeriodList');
  function addBreakRow(start = '', end = '') {
    const row = document.createElement('div');
    row.setAttribute('data-break-item', '1');
    row.style.display = 'flex'; row.style.gap = '8px'; row.style.margin = '6px 0';
    row.innerHTML = `
      <input data-break-start type="time" value="${start}" />
      <input data-break-end type="time" value="${end}" />
      <button type="button">åˆªé™¤</button>
    `;
    row.querySelector('button').addEventListener('click', () => row.remove());
    breakPeriodList.appendChild(row);
  }
  // è‹¥é é¢å·²å®šç¾© addBreakPeriod å‡½å¼ï¼Œå‰‡è¦†è“‹ç‚ºä½¿ç”¨ä¸Šè¿° DOM
  window.addBreakPeriod = function() { addBreakRow(); };

  // DateTypes æ“ä½œçš„ç°¡æ˜“å…¥å£ï¼šå¾é é¢å››ç¨®æ—¥æœŸç¾¤çµ„æŒ‰éˆ•è§¸ç™¼ï¼ˆaddDate(type)ï¼‰
  window.addDate = async function(type) {
    try {
      const map = {
        holiday: 'holidayInput', blockedDay: 'blockedDayInput', eventDay: 'eventDayInput', halfDay: 'halfDayInput'
      };
      const id = map[type];
      if (!id) return alert('æœªçŸ¥é¡å‹');
      const date = document.getElementById(id).value;
      if (!date) return alert('è«‹é¸æ“‡æ—¥æœŸ');
      // åŒæ™‚å‚³ Type èˆ‡ DateTypeï¼Œæå‡å¾Œç«¯ç›¸å®¹æ€§
      const res = await apiPost({ entity: 'datetypes', action: 'create', data: { Type: type, DateType: type, Date: date } });
      if (res.ok) { alert('å·²æ–°å¢ ' + type + 'ï¼š' + date); try { renderDateTypes(); } catch {} }
      else alert('æ–°å¢å¤±æ•—ï¼š' + (res.error || ''));
    } catch (err) {
      alert('æ“ä½œå¤±æ•—ï¼š' + String(err));
    }
  };

  // æœå‹™é …ç›®ç®¡ç†ï¼šä¾ç¾æœ‰ UIï¼ˆserviceTypeSelectã€serviceListã€addServiceBtnï¼‰æä¾›ç°¡æ˜“æ–°å¢ä¸»/åŠ è³¼æœå‹™
  const addServiceBtn = document.getElementById('addServiceBtn');
  const servicesMsg = document.getElementById('servicesMsg');
  const servicesRefreshBtn = document.getElementById('servicesRefresh');
  const weeklyRefreshBtn = document.getElementById('weeklyRefresh');
  const weeklyMsg = document.getElementById('weeklyMsg');
  const datesRefreshBtn = document.getElementById('datesRefresh');
  const datesMsg = document.getElementById('datesMsg');
  // ç›´è¦ºçš„æ–°å¢æœå‹™ï¼šä½¿ç”¨é é¢ä¸‹æ–¹çš„è¼¸å…¥è¡¨å–®ï¼ˆå½ˆå‡ºå°è©±æ¡†æ”¹ç‚ºè¡Œå…§è¼¸å…¥ï¼‰
  addServiceBtn.addEventListener('click', async () => {
    try {
      const isAddonType = document.getElementById('serviceTypeSelect').value === 'addon';
      // å»ºç«‹è¡Œå…§è¼¸å…¥åˆ—
      const container = document.getElementById('serviceList');
      const formRow = document.createElement('div');
      formRow.style.display = 'grid';
      formRow.style.gridTemplateColumns = '2fr 1fr 1fr 1fr auto';
      formRow.style.gap = '8px';
      formRow.style.margin = '8px 0';
      formRow.innerHTML = `
        <input type="text" placeholder="æœå‹™åç¨±" />
        <input type="number" placeholder="åˆ†é˜" />
        <input type="number" placeholder="åƒ¹æ ¼" />
        <input type="text" placeholder="åˆ†é¡ï¼ˆä¾‹ï¼šå…¨èº«æŒ‰æ‘©ï¼‰" ${isAddonType ? 'value="åŠ è³¼æœå‹™"' : ''} />
        <button type="button">å„²å­˜</button>
      `;
      const [nameEl, minEl, priceEl, typeEl, saveBtn] = formRow.querySelectorAll('input,button');
      container.prepend(formRow);
      saveBtn.addEventListener('click', async () => {
        const ServiceName = nameEl.value.trim();
        const TimeMinutes = Number(minEl.value || '0');
        const Price = Number(priceEl.value || '0');
        const Type = typeEl.value.trim();
        const IsAddon = isAddonType ? 'TRUE' : 'FALSE';
        if (!ServiceName) return alert('è«‹è¼¸å…¥æœå‹™åç¨±');
        const res = await apiPost({ entity: 'services', action: 'create', data: { ServiceName, TimeMinutes, Price, Type, IsAddon } });
        if (res.ok) { alert('æœå‹™å·²æ–°å¢'); renderServices(); formRow.remove(); }
        else { alert('æ–°å¢å¤±æ•—ï¼š' + (res.error || '')); }
      });
    } catch (err) { alert('æ“ä½œå¤±æ•—ï¼š' + String(err)); }
  });

  // æœå‹™åˆ—è¡¨æ¸²æŸ“ï¼šå¾ services list è®€å–ä¸¦åˆ†é¡å±•ç¤º
  async function renderServices() {
    try {
      const res = await apiGet({ entity: 'services', action: 'list' });
      if (!res.ok) { servicesMsg.textContent = res.error || 'è¼‰å…¥å¤±æ•—'; servicesMsg.className = 'small error'; return; }
      const data = Array.isArray(res.data) ? res.data : [];
      servicesMsg.textContent = `å…± ${data.length} ç­†`; servicesMsg.className = 'small success';
      const container = document.getElementById('serviceList');
      container.innerHTML = '';
      const main = data.filter(d => String(d.IsAddon).toUpperCase() !== 'TRUE');
      const addon = data.filter(d => String(d.IsAddon).toUpperCase() === 'TRUE');
      const section = (title, items) => {
        const wrap = document.createElement('div');
        wrap.style.marginTop = '8px';
          const h = document.createElement('h3'); h.textContent = title; h.className = 'section-title';
          if (title.includes('ä¸»æœå‹™')) wrap.classList.add('service-section-main');
          if (title.includes('åŠ è³¼æœå‹™')) wrap.classList.add('service-section-addon');
        wrap.appendChild(h);
        const table = document.createElement('table');
          table.style.width = '100%'; table.style.borderCollapse = 'collapse';
          table.innerHTML = `<thead><tr>
          <th style="text-align:left;">æœå‹™åç¨±</th>
          <th>åˆ†é˜</th>
          <th>åƒ¹æ ¼</th>
          <th>åˆ†é¡</th>
          <th>æ“ä½œ</th>
        </tr></thead><tbody></tbody>`;
        const tbody = table.querySelector('tbody');
        items.forEach(it => {
          const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${it.ServiceName}</td>
            <td>${it.TimeMinutes}</td>
            <td>$${it.Price}</td>
            <td>${it.Type}</td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-primary soft" data-act="edit">ä¿®æ”¹</button>
                <button type="button" class="btn btn-danger soft" data-act="del">åˆªé™¤</button>
              </div>
            </td>`;
          tr.querySelector('[data-act="del"]').addEventListener('click', async (e) => {
            e.preventDefault();
            if (!confirm(`ç¢ºå®šåˆªé™¤ï¼š${it.ServiceName}ï¼Ÿ`)) return;
            const res = await apiPost({ entity: 'services', action: 'delete', key: it.ServiceName });
            if (res.ok) renderServices(); else alert('åˆªé™¤å¤±æ•—ï¼š' + (res.error || ''));
          });
          tr.querySelector('[data-act="edit"]').addEventListener('click', (e) => {
            e.preventDefault();
            // è¡Œå…§ç·¨è¼¯
            const name = prompt('æœå‹™åç¨±', it.ServiceName) || it.ServiceName;
            const minutes = Number(prompt('åˆ†é˜', it.TimeMinutes) || it.TimeMinutes);
            const price = Number(prompt('åƒ¹æ ¼', it.Price) || it.Price);
            const type = prompt('åˆ†é¡', it.Type) || it.Type;
            const payload = { entity: 'services', action: 'update', key: it.ServiceName, data: { ServiceName: name, TimeMinutes: minutes, Price: price, Type: type, IsAddon: String(it.IsAddon).toUpperCase() === 'TRUE' ? 'TRUE' : 'FALSE' } };
            apiPost(payload).then(res => { if (res.ok) renderServices(); else alert('ä¿®æ”¹å¤±æ•—ï¼š' + (res.error || '')); });
          });
          tbody.appendChild(tr);
        });
        wrap.appendChild(table);
        return wrap;
      };
      container.appendChild(section('ä¸»æœå‹™', main));
      container.appendChild(section('åŠ è³¼æœå‹™', addon));
    } catch (err) {
      servicesMsg.textContent = String(err); servicesMsg.className = 'small error';
    }
  }
  servicesRefreshBtn.addEventListener('click', renderServices);

  // æ¯é€±å›ºå®šä¼‘å‡æ¸²æŸ“ï¼šå¾ Config.weeklyOff é å¡«å‹¾é¸ä¸¦é¡¯ç¤ºç­†æ•¸
  async function renderWeeklyOff() {
    try {
      const res = await apiGet({ entity: 'config', action: 'list' });
      if (!res.ok) { weeklyMsg.textContent = res.error || 'è¼‰å…¥å¤±æ•—'; weeklyMsg.className = 'small error'; return; }
      const offs = (() => { try { return JSON.parse(res.data.weeklyOff || '[]'); } catch { return []; } })();
      const boxes = Array.from(document.querySelectorAll('#weeklyOffCheckboxes input[type="checkbox"]'));
      boxes.forEach(cb => { cb.checked = offs.includes(cb.value); });
      weeklyMsg.textContent = `ç›®å‰è¨­å®šï¼š${offs.join(', ') || 'ï¼ˆç„¡ï¼‰'}`; weeklyMsg.className = 'small success';
    } catch (err) {
      weeklyMsg.textContent = String(err); weeklyMsg.className = 'small error';
    }
  }
  weeklyRefreshBtn.addEventListener('click', renderWeeklyOff);

  // æ—¥æœŸæ ¼å¼å·¥å…·ï¼šå»ºç«‹åˆªé™¤æ™‚å¯å˜—è©¦çš„å¤šç¨®æ—¥æœŸå­—ä¸²
  function pad2(n) { return String(n).padStart(2, '0'); }
  function unique(arr) { return Array.from(new Set(arr.filter(Boolean))); }
  function excelSerialToISO(n) {
    const base = new Date(Date.UTC(1899, 11, 30));
    const ms = base.getTime() + Math.round(Number(n)) * 86400000;
    const d = new Date(ms);
    return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth() + 1)}-${pad2(d.getUTCDate())}`;
  }
  function normalizeYMD(y, m, d) {
    const yy = String(y).padStart(4, '0');
    const mm = pad2(m);
    const dd = pad2(d);
    return {
      dash: `${yy}-${mm}-${dd}`,
      slash: `${yy}/${mm}/${dd}`
    };
  }
  function buildDateCandidates(raw) {
    const out = [];
    const v = raw == null ? '' : String(raw).trim();
    if (!v) return out;
    out.push(v);
    // yyyy-mm-dd or yyyy/mm/dd
    let m = v.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})(?:\D.*)?$/);
    if (m) {
      const { dash, slash } = normalizeYMD(m[1], m[2], m[3]);
      out.push(dash, slash);
    }
    // mm-dd-yyyy or mm/dd/yyyy
    m = v.match(/^(\d{1,2})[-/](\d{1,2})[-/](\d{4})(?:\D.*)?$/);
    if (m) {
      const { dash, slash } = normalizeYMD(m[3], m[1], m[2]);
      out.push(dash, slash);
    }
    // ISO with time
    try {
      const d = new Date(v);
      if (!isNaN(d.getTime())) {
        const iso = `${d.getUTCFullYear()}-${pad2(d.getUTCMonth() + 1)}-${pad2(d.getUTCDate())}`;
        out.push(iso, iso.replace(/-/g, '/'));
      }
    } catch {}
    // Excel serial
    if (/^\d{4,6}$/.test(v)) {
      try {
        const iso = excelSerialToISO(v);
        out.push(iso, iso.replace(/-/g, '/'));
      } catch {}
    }
    return unique(out);
  }
  async function attemptDeleteDateType(type, dateStr) {
    const cap = (s) => (s ? s.charAt(0).toUpperCase() + s.slice(1) : s);
    // å˜—è©¦ payload1
    let payload = {
      entity: 'datetypes',
      action: 'delete',
      key: { DateType: type, Type: type, Date: dateStr },
      DateType: type,
      Type: type,
      Date: dateStr,
      data: { DateType: type, Type: type, Date: dateStr }
    };
    try { console.debug('[datetypes:delete] try payload#1', payload); } catch {}
    let res = await apiPost(payload);
    try { console.debug('[datetypes:delete] response#1', res); } catch {}
    if (res && res.ok) return res;
    // å˜—è©¦ payload2ï¼ˆé¦–å­—å¤§å¯«ï¼‰
    payload = {
      entity: 'datetypes',
      action: 'delete',
      key: { DateType: cap(type), Type: cap(type), Date: dateStr },
      DateType: cap(type),
      Type: cap(type),
      Date: dateStr,
      data: { DateType: cap(type), Type: cap(type), Date: dateStr }
    };
    try { console.debug('[datetypes:delete] try payload#2', payload); } catch {}
    res = await apiPost(payload);
    try { console.debug('[datetypes:delete] response#2', res); } catch {}
    return res;
  }

  // ç‰¹æ®Šæ—¥æœŸæ¸²æŸ“ï¼šè®€å– datetypesï¼Œä¾ Type é¡åˆ¥åˆ†çµ„é¡¯ç¤º
  async function renderDateTypes() {
    try {
      const res = await apiGet({ entity: 'datetypes', action: 'list' });
      if (!res.ok) { datesMsg.textContent = res.error || 'è¼‰å…¥å¤±æ•—'; datesMsg.className = 'small error'; return; }
      const data = Array.isArray(res.data) ? res.data : [];
      datesMsg.textContent = `å…± ${data.length} ç­†`; datesMsg.className = 'small success';
      // åŒæ™‚æ”¯æ´ r.Type èˆ‡ r.DateType å…©ç¨®æ¬„ä½
      const byType = (t) => data.filter(r => r && (r.Type === t || r.DateType === t));
      const renderList = (id, items, type) => {
        const el = document.getElementById(id);
        el.innerHTML = '';
        if (!items.length) { el.textContent = 'ï¼ˆç„¡ï¼‰'; return; }
        const table = document.createElement('table');
        table.className = 'table table-striped table-sm';
        table.innerHTML = `<thead><tr><th class="text-start">æ—¥æœŸ</th><th class="text-start">æ“ä½œ</th></tr></thead><tbody></tbody>`;
        const tbody = table.querySelector('tbody');
        // é¡¯ç¤ºå‰å˜—è©¦åµæ¸¬æ—¥æœŸæ ¼å¼ï¼ˆåƒ…é™¤éŒ¯ï¼‰
        try {
          const formats = unique(items.map(x => (x && x.Date ? String(x.Date) : '')).map(s => (s.includes('T') ? 'ISO-with-time' : s.includes('/') ? 'yyyy/MM/dd' : s.includes('-') ? 'yyyy-MM-dd' : 'other')));
          console.debug(`[datetypes:list:${type}] date formats`, formats);
        } catch {}
        items.forEach(({ Date }) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${Date}</td><td>
            <button type="button" class="btn btn-danger btn-sm soft" data-act="del">åˆªé™¤</button>
          </td>`;
          tr.querySelector('[data-act="del"]').addEventListener('click', async (e) => {
            e.preventDefault();
            if (!confirm(`ç¢ºå®šåˆªé™¤ï¼š${type} ${Date}ï¼Ÿ`)) return;
            const candidates = unique([String(Date), ...buildDateCandidates(Date), ...(typeof Date === 'string' ? [String(Date).replace(/-/g, '/'), String(Date).replace(/\//g, '-')] : [])]);
            try { console.debug('[datetypes:delete] candidates', candidates); } catch {}
            let res;
            for (const ds of candidates) {
              res = await attemptDeleteDateType(type, ds);
              if (res && res.ok) { try { console.debug('[datetypes:delete] success with date', ds); } catch {} break; }
            }
            if (res.ok) renderDateTypes(); else alert('åˆªé™¤å¤±æ•—ï¼š' + (res.error || ''));
          });
          tbody.appendChild(tr);
        });
        el.appendChild(table);
      };
      renderList('holidayList', byType('holiday'), 'holiday');
      renderList('blockedDayList', byType('blockedDay'), 'blockedDay');
      renderList('eventDayList', byType('eventDay'), 'eventDay');
      renderList('halfDayList', byType('halfDay'), 'halfDay');
    } catch (err) {
      datesMsg.textContent = String(err); datesMsg.className = 'small error';
    }
  }
  datesRefreshBtn.addEventListener('click', renderDateTypes);

  // ç°¡æ˜“ï¼šè¼‰å…¥ Config ä»¥é å¡« UI
  (async function preloadConfig() {
    try {
      // è‹¥ ENDPOINT æœªè¨­å®šå‰‡ä¸è¼‰å…¥
      if (!ENDPOINT) return;
      const res = await apiGet({ entity: 'config', action: 'list' });
      if (res.ok && res.data) {
        const cfg = res.data;
        // å°‡å¯èƒ½ç‚ºæ—¥æœŸå­—ä¸²çš„æ™‚é–“è½‰ç‚º HH:mm
        const toHHMM = (val) => {
          if (!val) return '';
          // è‹¥ç‚º "HH:mm" ç›´æ¥ä½¿ç”¨
          if (/^\d{2}:\d{2}(:\d{2}(\.\d{3})?)?$/.test(val)) return val.slice(0,5);
          try {
            const d = new Date(val);
            if (!isNaN(d.getTime())) {
              const hh = String(d.getHours()).padStart(2,'0');
              const mm = String(d.getMinutes()).padStart(2,'0');
              return `${hh}:${mm}`;
            }
          } catch {}
          return '';
        };
        if (cfg.startTime) document.getElementById('startTime').value = toHHMM(cfg.startTime);
        if (cfg.endTime) document.getElementById('endTime').value = toHHMM(cfg.endTime);
        if (cfg.bufferMinutes) document.getElementById('bufferMinutes').value = Number(cfg.bufferMinutes);
        if (cfg.maxBookingDays) document.getElementById('maxBookingDays').value = Number(cfg.maxBookingDays);
        if (cfg.breakPeriods) {
          try { JSON.parse(cfg.breakPeriods).forEach(b => addBreakRow(b.start, b.end)); } catch {}
        }
        if (cfg.weeklyOff) {
          try {
            const offs = JSON.parse(cfg.weeklyOff);
            Array.from(document.querySelectorAll('#weeklyOffCheckboxes input[type="checkbox"]')).forEach(cb => {
              cb.checked = offs.includes(cb.value);
            });
          } catch {}
        }
      }
      // åˆæ¬¡è¼‰å…¥åŒæ™‚æ¸²æŸ“ä¸‰å€å¡Š
      renderWeeklyOff();
      renderDateTypes();
      renderServices();
    } catch {}
  })();
</script>
<script>
  // ä¸»é¡Œåˆ‡æ›ï¼šä¾ localStorage åˆå§‹ã€è®Šæ›´ body data-theme
  (function themeInit(){
    const key = 'admin.theme';
    const saved = localStorage.getItem(key) || 'light';
    document.body.dataset.theme = saved;
    const toggle = document.getElementById('themeToggle');
    if (toggle) toggle.checked = saved === 'dark';
    if (toggle) toggle.addEventListener('change', () => {
      const v = toggle.checked ? 'dark' : 'light';
      document.body.dataset.theme = v;
      localStorage.setItem(key, v);
    });
  })();

  // ç¾åŒ–ï¼šæœå‹™åˆ—è¡¨çš„è¡¨æ ¼å¥—ç”¨ Bootstrap æ¨£å¼ï¼ˆåœ¨æ¸²æŸ“å¾Œç”± JS å»ºç«‹ï¼‰
  const _origRenderServices = renderServices;
  renderServices = async function(){
    await _origRenderServices();
    document.querySelectorAll('#serviceList table').forEach(t => {
      t.classList.add('table','table-striped','table-sm');
    });
  };
</script>
</body>
</html>
