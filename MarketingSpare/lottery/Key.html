<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ä¸€éµç”¢ç”Ÿé‡‘é‘° + æ›´æ–°è©¦ç®—è¡¨ + é¡¯ç¤º QR Code</title>

  <!-- QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", sans-serif;
      background: #f9fafb;
      color: #111827;
      padding: 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      width: 100%;
      max-width: 640px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      border: 1px solid #e5e7eb;
    }
    h1 {
      margin: 0 0 12px 0;
      font-size: 1.3rem;
      color: #1f2937;
    }
    .key {
      font-family: monospace;
      font-size: 1.05rem;
      padding: 10px;
      border-radius: 8px;
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      word-break: break-all;
      color: #111827;
    }
    .btns {
      margin-top: 12px;
      text-align: center;
    }
    button {
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: background 0.2s ease, color 0.2s ease;
    }
    .primary {
      background: #2563eb;
      color: #ffffff;
    }
    .primary:hover {
      background: #1e40af;
    }
    .status {
      margin-top: 10px;
      color: #4b5563;
      min-height: 1.2em;
    }
    .qr-wrapper {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    #qrcode {
      background: #ffffff;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      min-height: 220px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>ä¸€éµç”¢ç”Ÿ 20 ç¢¼é‡‘é‘° â†’ å¯«å…¥ Google è©¦ç®—è¡¨ â†’ ç”¢ç”Ÿ QR Code</h1>

    <div>
      <div style="font-size:0.9rem;color:#6b7280">ç›®å‰é‡‘é‘°å…§å®¹ï¼š</div>
      <div id="generatedKey" class="key">ï¼ˆè¼‰å…¥ä¸­...ï¼‰</div>
    </div>

    <div class="btns">
      <button id="generateAll" class="primary">ğŸš€ ä¸€éµç”¢ç”Ÿ + å¯«å…¥ + QR Code</button>
    </div>

    <div class="status" id="status">ç‹€æ…‹ï¼šåˆå§‹åŒ–ä¸­...</div>

    <div class="qr-wrapper">
      <div style="font-size:0.9rem;color:#6b7280">é‡‘é‘° QR Codeï¼š</div>
      <div id="qrcode">ï¼ˆå°šæœªç”¢ç”Ÿï¼‰</div>
    </div>

    <hr style="margin-top:16px;border:none;border-top:1px solid #e5e7eb" />

    <div style="font-size:0.85rem;color:#6b7280">
      è«‹ä¿®æ”¹ä»¥ä¸‹å…©å€‹è®Šæ•¸ä»¥é…åˆä½ çš„ Apps Scriptï¼š
      <ul style="margin:4px 0 0 18px;padding:0;">
        <li><code>API_URL</code>ï¼šä½ çš„ Apps Script Web App URLï¼ˆçµå°¾ç‚º /execï¼‰</li>
        <li><code>ADMIN_SECRET</code>ï¼šèˆ‡ Apps Script ç«¯è¨­å®šç›¸åŒçš„é©—è­‰å¯†é‘°</li>
      </ul>
    </div>
  </div>

  <script>
    // ===== é€™å…©å€‹è¦æ”¹æˆä½ çš„ =====
    const API_URL = 'https://script.google.com/macros/s/AKfycbybyOjMvi1mXrVcdayHOQmdeCN8apchtqghLHax_Hql2VLD7Lgzfyt5O7AXNVDD3xPguQ/exec';
    const ADMIN_SECRET = '123456789';
    // ============================

    const generateAllBtn = document.getElementById('generateAll');
    const generatedKeyEl = document.getElementById('generatedKey');
    const statusEl = document.getElementById('status');
    const qrContainer = document.getElementById('qrcode');

    // ç”¢ç”Ÿ 20 ç¢¼äº‚æ•¸
    function randomAlphaNum(len = 20) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      return Array.from({ length: len }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    }

    // ç”¢ç”Ÿ QR Code
    function renderQr(key) {
      qrContainer.innerHTML = '';
      new QRCode(qrContainer, {
        text: key,
        width: 200,
        height: 200,
        colorDark: "#111827",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.M
      });
    }

    // åˆå§‹åŒ–ï¼šæŠ“ç›®å‰è©¦ç®—è¡¨ A2 çš„å€¼
    async function fetchCurrentKey() {
      try {
        statusEl.textContent = 'ğŸ” æ­£åœ¨è®€å–ç›®å‰é‡‘é‘°...';
        const url = API_URL + '?action=get&secret=' + encodeURIComponent(ADMIN_SECRET);
        const res = await fetch(url);
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const data = await res.json();
        if (data.ok && data.key) {
          generatedKeyEl.textContent = data.key;
          statusEl.textContent = 'âœ… å·²è¼‰å…¥ç›®å‰é‡‘é‘°ã€‚';
          renderQr(data.key);
        } else {
          generatedKeyEl.textContent = 'ï¼ˆå°šæœªç”¢ç”Ÿï¼‰';
          statusEl.textContent = 'âš ï¸ è©¦ç®—è¡¨å°šç„¡é‡‘é‘°ï¼Œè«‹é»æ“ŠæŒ‰éˆ•ç”¢ç”Ÿã€‚';
        }
      } catch (err) {
        generatedKeyEl.textContent = 'ï¼ˆè®€å–å¤±æ•—ï¼‰';
        statusEl.textContent = 'âŒ ç„¡æ³•è®€å–é‡‘é‘°ï¼š' + err.message;
      }
    }

    // ä¸€éµç”¢ç”Ÿ + å¯«å…¥ + ç”¢ QR
    async function updateSheetAndShowQr() {
      const key = randomAlphaNum(20);
      generatedKeyEl.textContent = key;
      qrContainer.textContent = 'ç”¢ç”Ÿä¸­...';
      statusEl.textContent = 'æ­£åœ¨å¯«å…¥è©¦ç®—è¡¨...';

      try {
        const url = API_URL + '?action=update&key=' + encodeURIComponent(key) + '&secret=' + encodeURIComponent(ADMIN_SECRET);
        const res = await fetch(url, { method: 'GET' });
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const data = await res.json();
        if (data.ok && data.updated) {
          statusEl.textContent = 'âœ… å·²æ›´æ–°è©¦ç®—è¡¨ä¸¦ç”¢ç”Ÿ QR Codeã€‚';
          renderQr(key);
        } else {
          throw new Error(data.error || 'æœªçŸ¥éŒ¯èª¤');
        }
      } catch (err) {
        statusEl.textContent = 'âŒ æ›´æ–°å¤±æ•—ï¼š' + err.message;
        qrContainer.textContent = 'ï¼ˆæ›´æ–°å¤±æ•—ï¼‰';
      }
    }

    generateAllBtn.addEventListener('click', updateSheetAndShowQr);

    // é é¢è¼‰å…¥æ™‚å…ˆæŠ“ç›®å‰é‡‘é‘°
    fetchCurrentKey();
  </script>
</body>
</html>
