<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINE 登入示範</title>
    <script>
        // 設定 LINE 登入參數
        const CLIENT_ID = "2005939681"; // 替換為你的 Channel ID
        const REDIRECT_URI = "https://yongshengchen0615.github.io/ReserveTest/index.html"; // 替換為你的回調網址
        const STATE = "random_string"; // 可以使用隨機字串

        function loginWithLine() {
            const loginUrl = `https://access.line.me/oauth2/v2.1/authorize?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&state=${STATE}&scope=profile%20openid%20email`;
            window.location.href = loginUrl;
        }

        // 解析 URL 取得授權碼
        function getUrlParameter(name) {
            name = name.replace(/[[]/, "\\[").replace(/[\]]/, "\\]");
            const regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
            const results = regex.exec(window.location.search);
            return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
        }

        // 登入成功後處理 Callback
        window.onload = function() {
            const code = getUrlParameter("code");
            if (code) {
                document.getElementById("status").innerText = "登入成功，正在處理...";
                fetchToken(code);
            }
        };

        // 交換 access token 取得用戶資料
        async function fetchToken(code) {
            const response = await fetch("https://api.line.me/oauth2/v2.1/token", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: new URLSearchParams({
                    grant_type: "authorization_code",
                    code: code,
                    redirect_uri: REDIRECT_URI,
                    client_id: CLIENT_ID,
                    client_secret: "YOUR_CLIENT_SECRET" // 替換為你的 Channel Secret
                })
            });
            const data = await response.json();
            console.log(data);
            if (data.access_token) {
                fetchUserProfile(data.access_token);
            } else {
                document.getElementById("status").innerText = "登入失敗，請重試";
            }
        }

        // 取得用戶資料
        async function fetchUserProfile(accessToken) {
            const response = await fetch("https://api.line.me/v2/profile", {
                method: "GET",
                headers: {
                    Authorization: `Bearer ${accessToken}`
                }
            });
            const user = await response.json();
            document.getElementById("status").innerHTML = `
                <h3>歡迎, ${user.displayName}!</h3>
                <img src="${user.pictureUrl}" width="100" />
                <p>User ID: ${user.userId}</p>
            `;
        }
    </script>
</head>
<body>
    <h2>LINE 登入範例</h2>
    <button onclick="loginWithLine()">使用 LINE 登入</button>
    <div id="status"></div>
</body>
</html>
