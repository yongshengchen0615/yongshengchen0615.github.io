name: Bump Userscript Versions (Strategy B - changed files only)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  bump:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ✅ 防止 bot 自己 commit 又觸發自己造成迴圈
      - name: Stop if last commit is from bot
        run: |
          AUTHOR=$(git log -1 --pretty=format:'%an')
          echo "Last commit author: $AUTHOR"
          if [ "$AUTHOR" = "github-actions[bot]" ]; then
            echo "Bot commit detected. Stop workflow."
            exit 0
          fi

      # ✅ 只 bump「本次變更」的 JS（且在指定資料夾內）
      - name: Bump @version only for changed JS files under target dirs
        run: |
          python3 - << 'PY'
          import re
          import subprocess
          from pathlib import Path

          # ⭐ 只要維護這裡：要掃描的資料夾（可加多個）
          TARGET_DIRS = [
            "MassageParlorSystem/Development/ScriptCat",
            "MassageParlorSystem/Development/Shop/TainanFuqianStore/ScriptCat",
            # "OtherSystem/Userscripts",
          ]

          # 只支援：// @version      1.0  (x.y)
          VERSION_RE = re.compile(
              r"^(\s*//\s*@version\s+)(\d+)\.(\d+)\s*$",
              re.MULTILINE
          )

          def run_git(args):
            return subprocess.check_output(["git", *args], text=True).strip()

          # 取得這次 push 的「前一個 commit」
          # - push event: github.sha 是最新 commit；github.sha^ 是上一個
          # - workflow_dispatch: 可能沒有上一個範圍的意義，但仍可用 HEAD^..HEAD
          try:
            base = run_git(["rev-parse", "HEAD^"])
            head = run_git(["rev-parse", "HEAD"])
          except Exception:
            # fallback：至少處理 HEAD 的變更（通常不會走到）
            base = "HEAD^"
            head = "HEAD"

          # 找出本次變更檔案（含新增/修改/改名；不含刪除）
          diff_names = run_git(["diff", "--name-only", "--diff-filter=ACMR", f"{base}..{head}"])
          changed_files = [line.strip() for line in diff_names.splitlines() if line.strip()]

          target_prefixes = [str(Path(d).as_posix()).rstrip("/") + "/" for d in TARGET_DIRS]

          changed_js = []
          for f in changed_files:
            f_posix = Path(f).as_posix()
            if not f_posix.endswith(".js"):
              continue
            if any(f_posix.startswith(pref) for pref in target_prefixes):
              changed_js.append(Path(f_posix))

          print("== Diagnostics ==")
          print("TARGET_DIRS:", TARGET_DIRS)
          print("base..head:", f"{base}..{head}")
          print("Changed files:", len(changed_files))
          print("Changed JS in target dirs:", len(changed_js))

          if not changed_js:
            print("No changed JS files under target dirs. Nothing to bump.")
            raise SystemExit(0)

          bumped = []
          version_hits = 0

          for p in changed_js:
            if not p.exists():
              # 可能是 rename 邊界狀況或其他，跳過
              continue
            try:
              text = p.read_text(encoding="utf-8")
            except Exception:
              continue

            m = VERSION_RE.search(text)
            if not m:
              continue

            version_hits += 1
            major = int(m.group(2))
            minor = int(m.group(3)) + 1
            new_version = f"{major}.{minor}"

            new_text = VERSION_RE.sub(rf"\g<1>{new_version}", text, count=1)
            if new_text != text:
              p.write_text(new_text, encoding="utf-8")
              bumped.append((str(p), new_version))

          print("@version hits among changed JS:", version_hits)
          print("Files bumped:", len(bumped))

          if version_hits == 0:
            print("Changed JS files exist, but none contains '// @version x.y'. Nothing to bump.")
            raise SystemExit(0)

          if bumped:
            print("== Updated files ==")
            for f, v in bumped:
              print(f" - {f} -> {v}")
          PY

      - name: Commit & Push
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "chore: bump userscript versions"
          git push
