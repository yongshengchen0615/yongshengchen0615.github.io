name: Bump Userscript Versions (Strategy B)

on:
  workflow_dispatch:
  push:
    branches: ["main"] # 如果你的預設分支是 master，改成 ["master"]

permissions:
  contents: write

jobs:
  bump:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ✅ 防止 bot 自己 commit 又觸發自己造成迴圈
      - name: Stop if last commit is from bot
        run: |
          AUTHOR=$(git log -1 --pretty=format:'%an')
          echo "Last commit author: $AUTHOR"
          if [ "$AUTHOR" = "github-actions[bot]" ]; then
            echo "Bot commit detected. Stop workflow."
            exit 0
          fi

      # ✅ 策略B：掃描指定資料夾底下所有 *.js，只要有 // @version x.y 就 bump y+1
      - name: Bump @version in target JS files
        run: |
          python3 - << 'PY'
          import re
          from pathlib import Path

          # ⭐ 只要維護這裡：要掃描的資料夾（可加多個）
          TARGET_DIRS = [
            "MassageParlorSystem/ScriptCat/TestEnvironment",
            # "OtherSystem/Userscripts",
          ]

          # 只支援：// @version      1.0  (x.y)
          VERSION_RE = re.compile(
              r"^(\s*//\s*@version\s+)(\d+)\.(\d+)\s*$",
              re.MULTILINE
          )

          changed = []
          scanned_js = 0
          version_hits = 0
          missing_dirs = []

          for base in TARGET_DIRS:
            base_path = Path(base)
            if not base_path.exists():
              missing_dirs.append(base)
              continue

            js_files = list(base_path.rglob("*.js"))
            scanned_js += len(js_files)

            for p in js_files:
              try:
                text = p.read_text(encoding="utf-8")
              except Exception:
                # 非 UTF-8 或讀不到，跳過
                continue

              m = VERSION_RE.search(text)
              if not m:
                continue

              version_hits += 1
              major = int(m.group(2))
              minor = int(m.group(3)) + 1
              new_version = f"{major}.{minor}"

              # ✅ 關鍵修正：用 \g<1> 避免 \1{digit} 被誤判成 \11
              new_text = VERSION_RE.sub(rf"\g<1>{new_version}", text, count=1)

              p.write_text(new_text, encoding="utf-8")
              changed.append((str(p), new_version))

          print("== Diagnostics ==")
          print("TARGET_DIRS:", TARGET_DIRS)
          print("Missing dirs:", missing_dirs)
          print("Total .js scanned:", scanned_js)
          print("@version hits:", version_hits)
          print("Files changed:", len(changed))

          if missing_dirs:
            raise SystemExit(f"❌ Missing target directories: {missing_dirs}")

          if scanned_js == 0:
            raise SystemExit("❌ No .js files found under TARGET_DIRS (check paths/case).")

          if version_hits == 0:
            raise SystemExit("❌ Found .js files, but none contains '// @version x.y'.")

          if changed:
            print("== Updated files ==")
            for f, v in changed:
              print(f" - {f} -> {v}")
          PY

      - name: Commit & Push
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "chore: bump userscript versions"
          git push
