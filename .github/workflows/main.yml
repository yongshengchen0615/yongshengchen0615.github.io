name: Bump Userscript @version

on:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ✅ 避免「actions 自己 commit → 又觸發自己」造成無限迴圈
      - name: Stop if last commit is from bot
        run: |
          AUTHOR=$(git log -1 --pretty=format:'%an')
          echo "Last commit author: $AUTHOR"
          if [ "$AUTHOR" = "github-actions[bot]" ]; then
            echo "Bot commit detected. Stop."
            exit 0
          fi

      - name: Bump @version in ReadyEventONLY.js
        run: |
          FILE="ReadyEventONLY.js"

          python3 - << 'PY'
          import re
          from pathlib import Path

          file = Path("ReadyEventONLY.js")
          s = file.read_text(encoding="utf-8")

          # 支援 @version x.y（例如 1.0）
          m = re.search(r"^(\s*//\s*@version\s+)(\d+)\.(\d+)\s*$", s, re.M)
          if not m:
            raise SystemExit("Cannot find @version x.y format (example: // @version 1.0)")

          prefix, major, minor = m.group(1), int(m.group(2)), int(m.group(3))
          minor += 1
          new = f"{major}.{minor}"

          s2 = re.sub(
            r"^(\s*//\s*@version\s+)\d+\.\d+\s*$",
            rf"\g<1>{new}",
            s,
            flags=re.M
          )

          file.write_text(s2, encoding="utf-8")
          print("Bumped to:", new)
          PY

      - name: Commit & Push
        run: |
          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ReadyEventONLY.js
          git commit -m "chore: bump userscript version"
          git push
