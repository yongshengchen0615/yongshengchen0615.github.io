name: Bump Userscript @version

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ✅ 避免 actions 自己 commit 又觸發自己造成迴圈
      - name: Stop if last commit is from bot
        run: |
          AUTHOR=$(git log -1 --pretty=format:'%an')
          echo "Last commit author: $AUTHOR"
          if [ "$AUTHOR" = "github-actions[bot]" ]; then
            echo "Bot commit detected. Stop."
            exit 0
          fi

      - name: Bump @version (x.y -> x.(y+1))
        run: |
          FILE="MassageParlorSystem/ScriptCat/TestEnvironment/Local/ReadyEventONLY.js"
          echo "Target file: $FILE"

          if [ ! -f "$FILE" ]; then
            echo "❌ File not found: $FILE"
            echo "Repo tree (top 4 levels):"
            find . -maxdepth 4 -type f | sed 's|^\./||'
            exit 1
          fi

          python3 - << 'PY'
          import re
          from pathlib import Path

          path = Path("MassageParlorSystem/ScriptCat/TestEnvironment/Local/ReadyEventONLY.js")
          s = path.read_text(encoding="utf-8")

          # 支援：// @version      1.0
          m = re.search(r"^(\s*//\s*@version\s+)(\d+)\.(\d+)\s*$", s, re.M)
          if not m:
            raise SystemExit("❌ Cannot find @version x.y line (example: // @version 1.0)")

          major = int(m.group(2))
          minor = int(m.group(3))
          minor += 1
          new_ver = f"{major}.{minor}"

          s2 = re.sub(
            r"^(\s*//\s*@version\s+)\d+\.\d+\s*$",
            rf"\g<1>{new_ver}",
            s,
            flags=re.M
          )

          path.write_text(s2, encoding="utf-8")
          print("✅ Bumped to:", new_ver)
          PY

      - name: Commit & Push
        run: |
          FILE="MassageParlorSystem/ScriptCat/TestEnvironment/Local/ReadyEventONLY.js"

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$FILE"
          git commit -m "chore: bump userscript version"
          git push
