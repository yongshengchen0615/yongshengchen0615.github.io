name: Bump Userscript Versions (Strategy B)

on:
  workflow_dispatch:
  push:
    branches: ["main"]   # 如果你是 master 改成 ["master"]

permissions:
  contents: write

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Stop if last commit is from bot
        run: |
          AUTHOR=$(git log -1 --pretty=format:'%an')
          echo "Last commit author: $AUTHOR"
          if [ "$AUTHOR" = "github-actions[bot]" ]; then
            echo "Bot commit detected. Stop workflow."
            exit 0
          fi

      - name: Debug repo tree (top)
        run: |
          echo "== PWD =="
          pwd
          echo "== ls -la =="
          ls -la
          echo "== find .github/workflows =="
          find .github/workflows -maxdepth 1 -type f -print || true
          echo "== find MassageParlorSystem (maxdepth 4) =="
          find MassageParlorSystem -maxdepth 4 -type d -print || true

      - name: Bump @version in target JS files (with diagnostics)
        run: |
          python3 - << 'PY'
          import re
          from pathlib import Path

          # ✅ 你的目標資料夾（策略 B）
          TARGET_DIRS = [
            "MassageParlorSystem/ScriptCat/TestEnvironment/Local",
          ]

          # 只支援 x.y（例如 1.0）
          VERSION_RE = re.compile(r"^(\s*//\s*@version\s+)(\d+)\.(\d+)\s*$", re.MULTILINE)

          changed = []
          scanned_js = 0
          version_hits = 0
          missing_dirs = []

          for base in TARGET_DIRS:
            base_path = Path(base)
            if not base_path.exists():
              missing_dirs.append(base)
              continue

            js_files = list(base_path.rglob("*.js"))
            scanned_js += len(js_files)

            for p in js_files:
              try:
                txt = p.read_text(encoding="utf-8", errors="strict")
              except Exception:
                # 有些檔案不是 UTF-8，跳過但印一下（避免你以為沒掃到）
                print(f"⚠️ Skip non-utf8/unreadable: {p}")
                continue

              m = VERSION_RE.search(txt)
              if not m:
                continue

              version_hits += 1
              major = int(m.group(2))
              minor = int(m.group(3)) + 1
              new_ver = f"{major}.{minor}"

              new_txt = VERSION_RE.sub(rf"\1{new_ver}", txt, count=1)
              p.write_text(new_txt, encoding="utf-8")
              changed.append((str(p), new_ver))

          print("== Diagnostics ==")
          print("TARGET_DIRS:", TARGET_DIRS)
          print("Missing dirs:", missing_dirs)
          print("Total .js scanned:", scanned_js)
          print("@version hits:", version_hits)
          print("Files changed:", len(changed))

          if missing_dirs:
            raise SystemExit(f"❌ Missing target directories: {missing_dirs}")

          if scanned_js == 0:
            raise SystemExit("❌ No .js files found under TARGET_DIRS (check paths/case).")

          if version_hits == 0:
            raise SystemExit("❌ Found .js files, but none contains '// @version x.y'.")

          if changed:
            print("== Updated files ==")
            for f, v in changed:
              print(f" - {f} -> {v}")
          PY

      - name: Commit & Push
        run: |
          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "chore: bump userscript versions"
          git push
